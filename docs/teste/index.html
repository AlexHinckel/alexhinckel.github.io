<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Alex Hinckel">
        <link rel="canonical" href="https://alexhinckel.github.io/teste/">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Teste - Alex Hinckel</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Alex Hinckel</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Index</a>
                            </li>
                            <li class="navitem active">
                                <a href="./" class="nav-link">Teste</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href=".." class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" class="nav-link disabled">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/AlexHinckel/edit/master/docs/teste.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            
            
            
            
            
            
            
            
            
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h5 id="infraestrutura">Infraestrutura</h5>
<p>Segue abaixo documentação da nova infraestrutura em Cluster.</p>
<ul>
<li>**Desenvolvimento**</li>
</ul>
<p>|**SERVIDOR** |**ENDEREÇO IP** |**FUNÇÃO** |**CPU**
|**RAM** |**DISCO** |
|VMHOMAPP-ESC01|172.31.22.4|Frontend/backend/NFS|4|16 GB|S.O +100
GB| |VMHOMAPP-ESC02|172.31.22.5|Frontend/backend|4|16 GB|S.O + 30
GB| |VMHOMAPP-ESC03|172.31.22.6|sys (controle)|2|4 GB|S.O + 30
GB| |VMHOMAPP-ESC04|172.31.22.7|sys (controle)|2|4 GB|S.O + 30
GB| |VMHOMAPP-ESCELA01|172.31.22.8|Elastic|4|16 GB|S.O + 100 GB|
|VMHOMAPP-ESCELA02|172.31.22.9|Elastic|4|16 GB|S.O + 100 GB|
|VMHOMAPP-ESCELA03|172.31.22.10|Elastic|4|16 GB|S.O + 100 GB|
|VMHOMDB-ESCMONGO01|172.31.22.11|Database|4|16 GB|S.O + 100 GB|
|VMHOMDB-ESCMONGO02|172.31.22.12|Database|4|16 GB|S.O + 100 GB|
|VMHOMDB-ESCMONGO03|172.31.22.13|Database|2|4 GB|S.O + 100 GB|</p>
<ul>
<li>**Produção**</li>
</ul>
<p>|**SERVIDOR** |**ENDEREÇO IP** |**FUNÇÃO** |**CPU**
|**RAM** |**DISCO** |
|VMPRDAPP-ESC01|172.31.24.4|Frontend/backend|8|32 GB|S.O + 50 GB|
|VMPRDAPP-ESC02|172.31.24.5|Frontend/backend|8|32 GB|S.O + 50 GB|
|VMPRDAPP-ESC03|172.31.24.6|sys (controle)|2|4 GB|S.O + 50 GB|
|VMPRDAPP-ESC04|172.31.24.7|sys (controle)|2|4 GB|S.O + 50 GB|
|VMPRDAPP-ESCELA01|172.31.24.8|Elastic|8|16 GB|S.O + 150 GB|
|VMPRDAPP-ESCELA02|172.31.24.9|Elastic|8|16 GB|S.O + 150 GB|
|VMPRDAPP-ESCELA03|172.31.24.10|Elastic|8|16 GB|S.O + 150 GB|
|VMPRDDB-ESCMONGO01|172.31.24.11|Database|4|16 GB|S.O + 350 GB|
|VMPRDDB-ESCMONGO02|172.31.24.12|Database|4|16 GB|S.O + 750 GB|
|VMPRDDB-ESCMONGO03|172.31.24.13|Database|2|4 GB|S.O + 200 GB|
|VMPRDAPP-ESCFILES|172.31.24.14|Armazenmento de arquivos NFS|4|4
GB|S.O + 1.5 TB|</p>
<h5 id="url">URL</h5>
<ul>
<li>
<ul>
<li>Desenvolvimento**</li>
</ul>
</li>
</ul>
<p><a href="https://devservicodigital.curitiba.pr.gov.br" title="wikilink"><a href="https://devservicodigital.curitiba.pr.gov.br">https://devservicodigital.curitiba.pr.gov.br</a></a>\\
<a href="https://homservicodigital.curitiba.pr.gov.br" title="wikilink"><a href="https://homservicodigital.curitiba.pr.gov.br">https://homservicodigital.curitiba.pr.gov.br</a></a>\\
<a href="https://dev-pmcdigital.curitiba.pr.gov.br" title="wikilink"><a href="https://dev-pmcdigital.curitiba.pr.gov.br">https://dev-pmcdigital.curitiba.pr.gov.br</a></a>\\
<a href="https://hom-pmcdigital.curitiba.pr.gov.br" title="wikilink"><a href="https://hom-pmcdigital.curitiba.pr.gov.br">https://hom-pmcdigital.curitiba.pr.gov.br</a></a></p>
<ul>
<li>
<ul>
<li>Produção**</li>
</ul>
</li>
</ul>
<p><a href="https://servicodigital.curitiba.pr.gov.br" title="wikilink"><a href="https://servicodigital.curitiba.pr.gov.br">https://servicodigital.curitiba.pr.gov.br</a></a>\\
<a href="https://servicodigitalservidor.curitiba.pr.gov.br" title="wikilink"><a href="https://servicodigitalservidor.curitiba.pr.gov.br">https://servicodigitalservidor.curitiba.pr.gov.br</a></a>\\
<a href="https://pmcdigital.curitiba.pr.gov.br" title="wikilink"><a href="https://pmcdigital.curitiba.pr.gov.br">https://pmcdigital.curitiba.pr.gov.br</a></a></p>
<h5 id="elasticsearch">Elasticsearch</h5>
<p>Documentação da instalação do cluster Elasticsearch executada em
conjunto com o Analista Eduardo da empresa Sydle no dia
**19/05/2022**</p>
<ul>
<li>
<ul>
<li>OBS**: Efetuamos a instalação juntamente com a Sydle, seguindo
        as boas praticas e recomendações repassadas em videoconferência.</li>
</ul>
</li>
</ul>
<p>Segue em anexo documentação original encaminhada por e-mail ⇒
<code>{{:linux:solucoes:install_elasticsearch.txt|install_elasticsearch.txt}}</code>{=mediawiki}</p>
<p>Hardware utilizado seguindo a recomendação da Sydle</p>
<p><code>* 4 x Intel(R) Xeon(R) Platinum 8160 CPU @ 2.10GHz</code>\
<code>* 16 GB Memória RAM</code>\
<code>* 30 GB sistema operacional / 100 GB para o diretório /var/lib/elasticsearch</code></p>
<ul>
<li>
<ul>
<li>OBS**: configuração sugerida não foi suficiente, sendo
        necessário upgrade. Consulte o menu infraestrutura</li>
</ul>
</li>
</ul>
<p>Os passos para preparação do ambiente, instalação e configuração devem
ser executadas nos três servidores simultaneamente</p>
<p><code>&lt;code bash&gt;</code>{=html}</p>
<ol>
<li>Ajustes S.O</li>
</ol>
<p>vim /etc/security/limits.conf elasticsearch - nofile 999999
elasticsearch soft memlock unlimited elasticsearch hard memlock
unlimited</p>
<p>vim /etc/sysctl.conf vm.max_map_count=262144 vm.swappiness = 1</p>
<p>sysctl -p</p>
<p>sed -i \'s/SELINUX=enforcing/SELINUX=disabled/g\' /etc/selinux/config</p>
<ol>
<li>Instalação&gt;> arquivos disponíveis no owncloud&gt;> Soluções
    Tecnicas\Servers Linux\Sydle</li>
</ol>
<p>rpm -ivh jdk-11.0.15_linux-x64_bin.rpm</p>
<p>rpm -ivh elasticsearch-7.6.2-x86_64.rpm chown -R
elasticsearch.elasticsearch /var/lib/elasticsearch</p>
<p>vim /usr/lib/systemd/system/elasticsearch.service LimitNOFILE=999999
LimitNPROC=65536 LimitMEMLOCK=infinity</p>
<p>systemctl daemon-reload systemctl enable elasticsearch.service</p>
<ol>
<li>Editar configuração do Elasticsearch em todos os nodes -- (Exemplo)</li>
</ol>
<p>cat /etc/elasticsearch/elasticsearch.yml cluster.name:
sydleone-cluster-hom node.name: VMHOMAPP-ESCELA01 node.master: true
node.data: true node.ingest: false bootstrap.memory_lock: true
network.host: VMHOMAPP-ESCELA01 http.port: 9200 transport.tcp.port: 9300
discovery.zen.ping.unicast.hosts:
[\"VMHOMAPP-ESCELA01\",\"VMHOMAPP-ESCELA02\",\"VMHOMAPP-ESCELA03\"]
action.destructive_requires_name: false bootstrap.system_call_filter:
false action.auto_create_index:
\".watches,.triggered_watches,.watcher-history-*\" path.logs:
/var/log/elasticsearch path.data: /var/lib/elasticsearch
cluster.initial_master_nodes: VMHOMAPP-ESCELA01, VMHOMAPP-ESCELA02,
VMHOMAPP-ESCELA03 discovery.zen.minimum_master_nodes: 2
gateway.recover_after_nodes: 2 gateway.expected_nodes: 3
gateway.recover_after_time: 10m http.max_initial_line_length : 10mb
cluster.routing.allocation.disk.threshold_enabled: true
cluster.routing.allocation.disk.watermark.low: \"90%\"
cluster.routing.allocation.disk.watermark.high: \"95%\"
cluster.routing.allocation.disk.watermark.flood_stage: \"99%\"
indices.query.bool.max_clause_count: 3000</p>
<p>vim /etc/elasticsearch/jvm.options</p>
<ol>
<li>Xms represents the initial size of total heap space</li>
<li>Xmx represents the maximum size of total heap space</li>
</ol>
<p>-Xms11g -Xmx11g</p>
<ol>
<li>G1GC Configuration</li>
<li>NOTE: G1 GC is only supported on JDK version 10 or later</li>
<li>to use G1GC, uncomment the next two lines and update the version on
    the</li>
<li>following three lines to your version of the JDK</li>
</ol>
<p>10-13:-XX:-UseConcMarkSweepGC 10-13:-XX:-UseCMSInitiatingOccupancyOnly
11-:-XX: UseG1GC 11-:-XX:G1ReservePercent=25
11-:-XX:InitiatingHeapOccupancyPercent=30</p>
<ol>
<li>CVE-2021-44228 (log4j2)</li>
</ol>
<p>-Dlog4j2.formatMsgNoLookups=true</p>
<ol>
<li>Iniciar serviço em todos os nodes</li>
</ol>
<p>systemctl start elasticsearch.service</p>
<ol>
<li>Alterar parametros persistentes no node VMHOMAPP-ESCELA01</li>
</ol>
<p>curl -H \'Content-Type: application/json\' -XPUT
\"<a href="http://$HOSTNAME:9200/_cluster/settings">http://$HOSTNAME:9200/_cluster/settings</a>\" -d \'{</p>
<p><code>"persistent": {</code>\
<code>"cluster.routing.allocation.node_concurrent_incoming_recoveries": "20",</code>\
<code>"cluster.routing.allocation.cluster_concurrent_rebalance": "20",</code>\
<code>"cluster.routing.allocation.node_concurrent_recoveries": "20",</code>\
<code>"cluster.routing.allocation.node_initial_primaries_recoveries": "40",</code>\
<code>"cluster.routing.allocation.node_concurrent_outgoing_recoveries": "20",</code>\
<code>"cluster.max_shards_per_node": "30000",</code>\
<code>"indices.recovery.max_bytes_per_sec": "100mb",</code>\
<code>"action.search.shard_count.limit": "3000",</code>\
<code>"search.max_buckets": 100000,</code>\
<code>"cluster.routing.allocation.disk.threshold_enabled": "true",</code>\
<code>"cluster.routing.allocation.disk.watermark.low": "90%",</code>\
<code>"cluster.routing.allocation.disk.watermark.high": "95%",</code>\
<code>"cluster.routing.allocation.disk.watermark.flood_stage": "99%"</code>\
<code>}</code></p>
<p>}\'</p>
<ol>
<li>Testar serviço no node VMHOMAPP-ESCELA01</li>
</ol>
<p>[root\@VMHOMAPP-ESCELA01 \~]# curl \"\$HOSTNAME\":9200 {</p>
<p><code>"name" : "VMHOMAPP-ESCELA01",</code>\
<code>"cluster_name" : "sydleone-cluster-hom",</code>\
<code>"cluster_uuid" : "fUju0zLpQ5yLiaSUsfEj5w",</code>\
<code>"version" : {</code>\
<code>"number" : "7.6.2",</code>\
<code>"build_flavor" : "default",</code>\
<code>"build_type" : "rpm",</code>\
<code>"build_hash" : "ef48eb35cf30adf4db14086e8aabd07ef6fb113f",</code>\
<code>"build_date" : "2020-03-26T06:34:37.794943Z",</code>\
<code>"build_snapshot" : false,</code>\
<code>"lucene_version" : "8.4.0",</code>\
<code>"minimum_wire_compatibility_version" : "6.8.0",</code>\
<code>"minimum_index_compatibility_version" : "6.0.0-beta1"</code>\
<code>},</code>\
<code>"tagline" : "You Know, for Search"</code></p>
<p>}</p>
<p>root\@VMHOMAPP-ESCELA01 \~]# curl \"\$HOSTNAME\":9200/_cat/nodes?v ip
heap.percent ram.percent cpu load_1m load_5m load_15m node.role master
name 172.19.208.227 4 75 0 0.00 0.01 0.05 dlm * VMHOMAPP-ESCELA02
172.19.208.234 3 75 0 0.00 0.01 0.05 dlm - VMHOMAPP-ESCELA03
172.19.210.225 3 75 0 0.00 0.01 0.05 dlm - VMHOMAPP-ESCELA01</p>
<p>[root\@VMHOMAPP-ESCELA01 \~]# curl \"\$HOSTNAME\":9200/_cat/health
1652985296 18:34:56 sydleone-cluster-hom green 3 3 0 0 0 0 0 0 - 100.0%</p>
<p><code>&lt;/code&gt;</code>{=html}</p>
<p>O elasticsearch funciona através das portas **TCP 9200 e 9300**</p>
<ul>
<li>
<ul>
<li>Visualizar tamanho dos indices**</li>
</ul>
</li>
</ul>
<p><code>curl '</code><a href="http://172.31.31.199:9200/_cat/indices/?pretty&amp;s=store.size:desc"><code>http://172.31.31.199:9200/_cat/indices/?pretty&amp;s=store.size:desc</code></a><code>' | more</code></p>
<h5 id="tomcat">Tomcat</h5>
<p>Documentação da instalação do webserver Tomcat executada em conjunto com
o Analista Eduardo Legatti da empresa Sydle no dia **24/05/2022**</p>
<ul>
<li>
<ul>
<li>OBS**: Efetuamos a instalação juntamente com a Sydle, seguindo
        as boas praticas e recomendações repassadas em videoconferência.</li>
</ul>
</li>
</ul>
<p><code>&lt;code bash&gt;</code>{=html}</p>
<ol>
<li>Java</li>
</ol>
<p>/usr/local/jdk1.8.0_202</p>
<ol>
<li>Tomcat</li>
</ol>
<p>/usr/local/apache-tomcat-8.5.79</p>
<ol>
<li>Link Simbólico</li>
</ol>
<p>ls -l /usr/local/ lrwxrwxrwx 1 root root 12 May 24 14:15 jdk8 ->
jdk1.8.0_202 lrwxrwxrwx 1 deployer deployer 20 May 24 14:16 tomcat8 ->
apache-tomcat-8.5.79</p>
<ol>
<li>script inicialização</li>
</ol>
<p>vim /etc/init.d/tomcat8 chmod x /etc/init.d/tomcat8 chkconfig tomcat8 on</p>
<ol>
<li>Remoção de todas as aplicações default</li>
</ol>
<p>rm -rf /usr/local/tomcat8/webapps/*</p>
<p><code>&lt;/code&gt;</code>{=html}</p>
<p><code>&lt;code bash&gt;</code>{=html}</p>
<ol>
<li>Configurações efetuada no arquivo /usr/local/tomcat8/bin/catalina.sh</li>
<li>Servidores VMHOMAPP-ESC01 e VMHOMAPP-ESC02</li>
</ol>
<p>JAVA_HOME=/usr/local/jdk8</p>
<p>CATALINA_OPTS=\"-server -Xms12000M -Xmx12000M -XX:
UseStringDeduplication -XX: UseG1GC -XX:MaxGCPauseMillis=200
-XX:ParallelGCThreads=4 -XX:ConcGCThreads=4
-XX:InitiatingHeapOccupancyPercent=60 -Dfile.encoding=ISO8859_1
-Dmail.encoding=ISO8859_1 -Djava.awt.headless=true
-Djava.rmi.server.hostname=172.19.210.212 -Dcom.sun.management.jmxremote
-Dcom.sun.management.jmxremote.port=8010
-Dcom.sun.management.jmxremote.local.only=false
-Dcom.sun.management.jmxremote.authenticate=false
-Dcom.sun.management.jmxremote.ssl=false\" <code>&lt;/code&gt;</code>{=html}</p>
<p><code>&lt;code bash&gt;</code>{=html}</p>
<ol>
<li>Configurações efetuada no arquivo /usr/local/tomcat8/bin/catalina.sh</li>
<li>Servidores VMHOMAPP-ESC03 e VMHOMAPP-ESC04</li>
</ol>
<p>JAVA_HOME=/usr/local/jdk8</p>
<p>CATALINA_OPTS=\"-server -Xms3000M -Xmx3000M -XX: UseStringDeduplication
-XX: UseG1GC -XX:MaxGCPauseMillis=200 -XX:ParallelGCThreads=4
-XX:ConcGCThreads=4 -XX:InitiatingHeapOccupancyPercent=60
-Dfile.encoding=ISO8859_1 -Dmail.encoding=ISO8859_1
-Djava.awt.headless=true -Djava.rmi.server.hostname=172.19.210.212
-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=8010
-Dcom.sun.management.jmxremote.local.only=false
-Dcom.sun.management.jmxremote.authenticate=false
-Dcom.sun.management.jmxremote.ssl=false\" <code>&lt;/code&gt;</code>{=html}</p>
<h5 id="nfs">NFS</h5>
<p>Montar NFS para armazenamento dos dados nos 4 servidores Tomcat =⇒
/sydleone</p>
<p><code>* DEV = Usar a mesma infraestrutura de DEV</code>\
<code>* PRD = Servidor dedicado NFS</code></p>
<ul>
<li>
<ul>
<li>Criando espaço especifico para armazenamento dos dados **</li>
</ul>
</li>
</ul>
<p><code>&lt;code bash&gt;</code>{=html}</p>
<ol>
<li>chmod x rescan_lun_scsi.sh</li>
<li>./rescan_lun_scsi.sh</li>
<li>parted /dev/sdb</li>
<li>vgcreate vg_sydle /dev/sdb1</li>
<li>lvcreate -l 100%FREE -n lv_sydle vg_sydle</li>
<li>mkfs.xfs /dev/mapper/vg_sydle-lv_sydle</li>
<li>mkdir /sydleone</li>
</ol>
<pre><code>&lt;!-- --&gt;
</code></pre>
<ol>
<li>vim /etc/fstab</li>
</ol>
<p>/dev/mapper/vg_sydle-lv_sydle /sydleone xfs defaults 0 0
<code>&lt;/code&gt;</code>{=html}</p>
<ul>
<li>
<ul>
<li>Instalação e configuração NFS **</li>
</ul>
</li>
</ul>
<p><code>&lt;code bash&gt;</code>{=html}</p>
<ol>
<li>yum install nfs-utils rpcbind</li>
<li>systemctl start rpcbind</li>
<li>systemctl start nfs-server</li>
<li>systemctl start nfs-lock</li>
<li>systemctl start nfs-idmap</li>
<li>systemctl status nfs</li>
</ol>
<pre><code>&lt;!-- --&gt;
</code></pre>
<ol>
<li>chmod -R 755 /sydleone/</li>
<li>chown nfsnobody:nfsnobody /sydleone/</li>
</ol>
<pre><code>&lt;!-- --&gt;
</code></pre>
<ol>
<li>vim /etc/exports</li>
</ol>
<p>/sydleone 172.19.210.214(rw,sync) /sydleone 172.19.210.221(rw,sync)
/sydleone 172.19.210.224(rw,sync)</p>
<ol>
<li>exportfs</li>
<li>systemctl restart nfs-server</li>
</ol>
<pre><code>&lt;!-- --&gt;
</code></pre>
<ol>
<li>showmount -e VMHOMAPP-ESC01</li>
</ol>
<p>Export list for VMHOMAPP-ESC01: /sydleone
172.19.210.224,172.19.210.221,172.19.210.214 <code>&lt;/code&gt;</code>{=html}</p>
<p>Agora no cliente (máquina que irá montar o compartilhamento feito
anteriormente) execute:</p>
<p><code>&lt;code bash&gt;</code>{=html}</p>
<ol>
<li>yum install nfs-utils</li>
<li>usermod -a -G nfsnobody deployer</li>
<li>mkdir /sydleone</li>
<li>chown nfsnobody:nfsnobody /sydleone/</li>
<li>mount -t nfs vmhomapp-esc01:/sydleone /sydleone</li>
</ol>
<pre><code>&lt;!-- --&gt;
</code></pre>
<ol>
<li>vim /etc/fstab</li>
</ol>
<p>vmhomapp-esc01:/sydleone /sydleone nfs defaults 0 0 <code>&lt;/code&gt;</code>{=html}</p>
<h5 id="apache-httpd-apache_httpd">Apache httpd {#apache_httpd}</h5>
<p>Os procedimentos devem ser executados em **VMPRDAPP-ESC01** e
**VMPRDAPP-ESC02**</p>
<p><code>&lt;code bash&gt;</code>{=html}</p>
<ol>
<li>yum install httpd -y</li>
<li>systemctl enable --now httpd</li>
<li>rm -rf /usr/share/httpd/noindex/*</li>
</ol>
<pre><code>&lt;!-- --&gt;
</code></pre>
<ol>
<li>vim /etc/httpd/conf/httpd.conf</li>
</ol>
<pre><code>&lt;!-- --&gt;
</code></pre>
<ol>
<li>TIMEZONE</li>
</ol>
<p>SetEnv TZ America/Sao_Paulo</p>
<ol>
<li>SEGURANCA</li>
</ol>
<p>ServerSignature Off ServerTokens Prod TraceEnable Off <code>&lt;/code&gt;</code>{=html}</p>
<p>Configuração portal servicodigital.curitiba.pr.gov.br</p>
<p><code>&lt;code bash&gt;</code>{=html}</p>
<ol>
<li>cat /etc/httpd/conf.d/portal-pmcdigital.conf</li>
</ol>
<p>\<VirtualHost \*:80></p>
<p><code>ServerName servicodigital.curitiba.pr.gov.br</code>\
<code>ServerAlias servicodigitalinterno.curitiba.pr.gov.br</code>\
<code>DocumentRoot /var/www/portal-pmcdigital-pmc-prd</code>\
<code>RemoteIPHeader X-Forwarded-For</code></p>
<p><code>``&lt;Directory /var/www/portal-pmcdigital-pmc-prd&gt;</code>{=html}\
<code>Options Indexes FollowSymLinks</code>\
<code>Require all granted</code>\
<code>AllowOverride All</code>\
<code>``&lt;/Directory&gt;</code>{=html}</p>
<p><code>&lt;/VirtualHost&gt;</code>{=html} <code>&lt;/code&gt;</code>{=html}</p>
<p>Configuração portal servicodigitalservidor.curitiba.pr.gov.br</p>
<p><code>&lt;code bash&gt;</code>{=html}</p>
<ol>
<li>cat /etc/httpd/conf.d/servicodigitalservidor.conf</li>
</ol>
<p>\<VirtualHost \*:80></p>
<p><code>ServerName servicodigitalservidor.curitiba.pr.gov.br</code>\
<code>ServerAlias int-servicodigitalservidor.curitiba.pr.gov.br</code>\
<code>DocumentRoot /var/www/portal-pub-pmcdigital-pmc-prd</code>\
<code>RemoteIPHeader X-Forwarded-For</code></p>
<p><code>``&lt;Directory /var/www/portal-pub-pmcdigital-pmc-prd&gt;</code>{=html}\
<code>Options Indexes FollowSymLinks</code>\
<code>Require all granted</code>\
<code>AllowOverride All</code>\
<code>``&lt;/Directory&gt;</code>{=html}</p>
<p><code>&lt;/VirtualHost&gt;</code>{=html}</p>
<p><code>&lt;/code&gt;</code>{=html}</p>
<p>Efetuando **backup** dos portais em **VMPRDAPP-ESCPROC**</p>
<p><code>&lt;code bash&gt;</code>{=html}</p>
<ol>
<li>cd /var/www</li>
<li>tar -zcvf /root/backup.tar.gz portal-pmcdigital-pmc-prd
    portal-pub-pmcdigital-pmc-prd</li>
</ol>
<p><code>&lt;/code&gt;</code>{=html}</p>
<p>Restore dos arquivos em **VMPRDAPP-ESC01** e **VMPRDAPP-ESC02**</p>
<p><code>&lt;code bash&gt;</code>{=html}</p>
<ol>
<li>cd /var/www</li>
<li>tar -zxvf backup.tar.gz</li>
<li>rm -f backup.tar.gz</li>
</ol>
<p><code>&lt;/code&gt;</code>{=html}</p>
<h5 id="load-balance-load_balance">Load Balance {#load_balance}</h5>
<p>Executar configurações em **LBHASOLUTION1** e **LBHASOLUTION2**</p>
<p><code>&lt;code bash&gt;</code>{=html}</p>
<ol>
<li>cat /etc/haproxy/haproxy.cfg</li>
</ol>
<p><code>use_backend pmcdigital.curitiba.pr.gov.br             if { hdr_dom(host) -i pmcdigital.curitiba.pr.gov.br }</code>\
<code>use_backend servicodigital.curitiba.pr.gov.br         if { hdr_dom(host) -i servicodigital.curitiba.pr.gov.br }</code>\
<code>use_backend servicodigitalservidor.curitiba.pr.gov.br if { hdr_dom(host) -i servicodigitalservidor.curitiba.pr.gov.br }</code></p>
<p>backend pmcdigital.curitiba.pr.gov.br</p>
<p><code>option httpchk HEAD / HTTP/1.1\r\nHost:</code></p>
<p>pmcdigital.curitiba.pr.gov.br</p>
<p><code>http-check expect status 200</code>\
<code>server server01 vmprdapp-esc01.curitiba.pr.gov.br:8080 weight 1 maxconn 200</code>\
<code>server server02 vmprdapp-esc02.curitiba.pr.gov.br:8080 weight 1 maxconn 200</code></p>
<p>backend servicodigital.curitiba.pr.gov.br</p>
<p><code>option httpchk HEAD / HTTP/1.1\r\nHost: servicodigital.curitiba.pr.gov.br</code>\
<code>http-check expect status 200</code>\
<code>server server01 vmprdapp-esc01.curitiba.pr.gov.br:80 weight 1 maxconn 200</code>\
<code>server server02 vmprdapp-esc02.curitiba.pr.gov.br:80 weight 1 maxconn 200</code></p>
<p>backend servicodigitalservidor.curitiba.pr.gov.br</p>
<p><code>option httpchk HEAD / HTTP/1.1\r\nHost: servicodigitalservidor.curitiba.pr.gov.br</code>\
<code>http-check expect status 200</code>\
<code>server server01 vmprdapp-esc01.curitiba.pr.gov.br:80 weight 1 maxconn 200</code>\
<code>server server02 vmprdapp-esc02.curitiba.pr.gov.br:80 weight 1 maxconn 200</code></p>
<p><code>&lt;/code&gt;</code>{=html}</p>
<h5 id="gestao-de-mudanca-gestao_de_mudanca">Gestão de mudança {#gestão_de_mudança}</h5>
<h4 id="resumo">Resumo</h4>
<p>Será necessário alterar apontamento do proxy reverso. A infraestrutura
standalone esta hospedada na solução nginx (**vmprdprx-web**)</p>
<p><code>&lt;code bash&gt;</code>{=html}</p>
<ol>
<li>Sydle Java</li>
</ol>
<p>pmcdigital.curitiba.pr.gov.br [172.31.10.40] =&gt;
ep.curitiba.pr.gov.br:8443 [172.31.31.180]</p>
<ol>
<li>Sydle PHP</li>
</ol>
<p>servicodigital.curitiba.pr.gov.br [172.31.10.40] =&gt;
servicodigitalinterno.curitiba.pr.gov.br [172.31.31.180]
servicodigitalservidor.curitiba.pr.gov.br [172.31.10.40] =&gt;
int-servicodigitalservidor.curitiba.pr.gov.br [172.31.31.180]
<code>&lt;/code&gt;</code>{=html}</p>
<p>A nova infraestrutura será hospedada no Haproxy (**LBHASOLUTION**)</p>
<p><code>&lt;code bash&gt;</code>{=html}</p>
<ol>
<li>Sydle Java</li>
</ol>
<p>pmcdigital.curitiba.pr.gov.br [172.31.10.17] =&gt;
vmprdapp-esc01.curitiba.pr.gov.br:8080 [172.31.24.4]
pmcdigital.curitiba.pr.gov.br [172.31.10.17] =&gt;
vmprdapp-esc02.curitiba.pr.gov.br:8080 [172.31.24.5]</p>
<ol>
<li>Sydle PHP</li>
</ol>
<p>servicodigital.curitiba.pr.gov.br [172.31.10.17] =&gt;
vmprdapp-esc01.curitiba.pr.gov.br:80 [172.31.24.4]
servicodigitalservidor.curitiba.pr.gov.br [172.31.10.17] =&gt;
vmprdapp-esc01.curitiba.pr.gov.br:80 [172.31.24.5] <code>&lt;/code&gt;</code>{=html}</p>
<h4 id="procedimento-operacional-procedimento_operacional">Procedimento Operacional {#procedimento_operacional}</h4>
<p>Procedimentos a serem executados na **infraestrutura standalone**</p>
<p>2 - Desabilitar Organização \\ 3 - Parar Tomcat VMPRDAPP-ESCPROC,
VMPRDAPP-ESC01, VMPRDAPP-ESC02 \\ 4 - Parar MongoDB \\ 5 - Parar
Elastic ⇒ [root\@VMPRDAPP-INDEX \~]# systemctl stop elasticsearch
\\ 6 - Replicação dos arquivos /sydleone</p>
<p><code>&lt;code bash&gt;</code>{=html} [root\@VMPRDAPP-ESCPROC \~]# rsync /sydleone/
-arvz -e \'ssh -p 6293\' --progress --delete
root\@vmprdapp-escfiles.curitiba.pr.gov.br:/sydleone/</p>
<p>[root\@VMPRDAPP-ESCFILES \~]# chown -R nfsnobody:nfsnobody /sydleone/
; chmod -R 775 /sydleone/ <code>&lt;/code&gt;</code>{=html}</p>
<p>7 - Replicação Elastic</p>
<p>7.1 - Apagar todos os índices da estrutura nova [
**VMPRDAPP-ESCELA01, VMPRDAPP-ESCELA02, VMPRDAPP-ESCELA03** ]</p>
<p><code>&lt;code bash&gt;</code>{=html}</p>
<ol>
<li>systemctl stop elasticsearch</li>
<li>rm -rf /var/lib/elasticsearch/*</li>
</ol>
<p><code>&lt;/code&gt;</code>{=html}</p>
<p>7.2 - Replicação dados **VMPRDAPP-INDEX ⇒ VMPRDAPP-ESCELA01**</p>
<p><code>&lt;code bash&gt;</code>{=html}</p>
<ol>
<li>Replica</li>
</ol>
<p>[root\@VMPRDAPP-INDEX \~]# rsync /var/lib/elasticsearch/ -arvz -e
\'ssh -p 6293\' --progress --delete
root\@vmprdapp-escela01.curitiba.pr.gov.br:/var/lib/elasticsearch/</p>
<ol>
<li>Correção Permissões</li>
</ol>
<p>[root\@VMPRDAPP-ESCELA01 \~]# chown -R elasticsearch.elasticsearch
/var/lib/elasticsearch [root\@VMPRDAPP-ESCELA01 \~]# rm -f
/var/lib/elasticsearch/nodes/0/node.lock [root\@VMPRDAPP-ESCELA01
\~]# rm -f /var/lib/elasticsearch/nodes/0/_state <code>&lt;/code&gt;</code>{=html}</p>
<p>7.3 - Iniciar Elastic / Validação</p>
<p><code>&lt;code bash&gt;</code>{=html} [root\@VMPRDAPP-ESCELA01 \~]# systemctl start
elasticsearch [root\@VMPRDAPP-ESCELA02 \~]# systemctl start
elasticsearch [root\@VMPRDAPP-ESCELA03 \~]# systemctl start
elasticsearch</p>
<p>[root\@VMPRDAPP-ESCELA01 \~]# curl
\"<a href="http://172.31.24.8:9200/_cat/health">http://172.31.24.8:9200/_cat/health</a>\" <code>&lt;/code&gt;</code>{=html}</p>
<p>7.4 - Criação de replicas</p>
<p><code>&lt;code bash&gt;</code>{=html} [root\@VMPRDAPP-ESCELA01 \~]# curl -H
\'Content-Type: application/json\' -XPUT
\"<a href="http://$HOSTNAME:9200/*5d122d72727e59522b60c339">http://$HOSTNAME:9200/*5d122d72727e59522b60c339</a>.*/_settings\" -d
\'{\"index\" : {\"number_of_replicas\" : 1}}\'</p>
<p>[root\@VMPRDAPP-ESCELA01 \~]# curl -H \'Content-Type:
application/json\' -XPUT
\"<a href="http://$HOSTNAME:9200/*000000000000111111111111">http://$HOSTNAME:9200/*000000000000111111111111</a>.*/_settings\" -d
\'{\"index\" : {\"number_of_replicas\" : 1}}\'</p>
<ol>
<li>Validação</li>
</ol>
<p>[root\@VMPRDAPP-ESCELA01 \~]# curl
\"<a href="http://172.31.24.8:9200/_cat/allocation">http://172.31.24.8:9200/_cat/allocation</a>\" [root\@VMPRDAPP-ESCELA01
\~]# curl
\"<a href="http://172.31.24.8:9200/_cat/indices/">http://172.31.24.8:9200/_cat/indices/</a>*?h=index,pri,rep,docs.count,docs.deleted,pri.store.size&amp;s=pri.store.size:desc&amp;v\"
[root\@VMPRDAPP-ESCELA01 \~]# curl
\"<a href="http://172.31.24.8:9200/_cat/health">http://172.31.24.8:9200/_cat/health</a>\" <code>&lt;/code&gt;</code>{=html}</p>
<p>8 - Migração banco de dados MongoDB</p>
<p>8.1 - Parar serviço do mongodb nos servidores **VMPRDAPP-ECM
(172.31.31.181), VMPRDAPP-ESCPROCRPL (172.31.31.183), VMPRDAPP-ESCPROC
(172.31.31.180)**</p>
<p><code>su - mongodb</code>
<code>mongo --port 27017 --username "admin" --password "########" --authenticationDatabase "admin"</code>
<code>use admin</code> <code>db.shutdownServer()</code></p>
<p>8.2 Copiar os binários e remover dados desatualizados nos servidores
**VMPRDDB-ESCMONGO01, VMPRDDB-ESCMONGO02, VMPRDDB-ESCMONGO03**</p>
<p><code>cp -Ra /data/mongodb/mongodb-linux-x86_64-rhel70-4.2.17/ /data/ (temporariamente)</code>
<code>rm -rf /data/mongodb/*</code></p>
<p>8.3 - Replicar dados</p>
<p><code>&lt;code bash&gt;</code>{=html}</p>
<ol>
<li>Iniciar a cópia dentro do servidor VMPRDAPP-ESCPROCRPL
    (172.31.31.183)</li>
</ol>
<p>time rsync -av --delete -e \'ssh -p 6293\' /mongodb/data/*
root\@10.0.0.19:/data/mongodb</p>
<ol>
<li>Devolver o diretório
    /data/mongodb/mongodb-linux-x86_64-rhel70-4.2.17/ para o
    /data/mongodb (servidores ESCMONGO)</li>
</ol>
<p>mv /data/mongodb-linux-x86_64-rhel70-4.2.17/ /data/mongodb/</p>
<ol>
<li>Iniciar o serviço no nó Primário (VMPRDDB-ESCMONGO01)</li>
</ol>
<p>su - mongodb mongod --fork --config /etc/mongod.conf</p>
<ol>
<li>Conectar no MongoDB</li>
</ol>
<p>mongo --port 27017 --username \"admin\" --password \"########\"
--authenticationDatabase \"admin\"</p>
<ol>
<li>Refazer a configuração do replicaset</li>
</ol>
<p>cfg = {_id: \'sdlPrdSet\', members: [</p>
<p><code>{_id: 0, host: 'vmprddb-escmongo01:27017'},</code>\
<code>{_id: 1, host: 'vmprddb-escmongo02:27017'},</code>\
<code>{_id: 2, host: 'vmprddb-escmongo03:27017', arbiterOnly: true}]</code></p>
<p>}</p>
<p>rs.reconfig(cfg, {force: true});</p>
<ol>
<li>Acessar os servidores VMPRDDB-ESCMONGO02 e VMPRDDB-ESCMONGO03 e
    iniciar os serviços</li>
</ol>
<p>mv /data/mongodb-linux-x86_64-rhel70-4.2.17/ /data/mongodb/ su - mongodb
mongod --fork --config /etc/mongod.conf</p>
<ol>
<li>Alterar a prioridade do secondary para fazer failback automático
    caso o nó 1 caia e volte depois</li>
</ol>
<p>cfg = rs.conf(); cfg.members[1].priority = 0.5; rs.reconfig(cfg);</p>
<ol>
<li>Obs.: Durante a cópia para o servidor secundário, o status ficará
    sdlPrdSet:STARTUP2</li>
</ol>
<pre><code>&lt;!-- --&gt;
</code></pre>
<ol>
<li>Após a cópia dos dados, fazer as alterações nas bases escmongo
    (usando o nó primário)</li>
</ol>
<p>use 000000000000111111111111</p>
<p>db.getCollection(\'000000002337c25acecc394e\').update({\"_id\" :
ObjectId(\"000000000000000331111111\")},{\"\$set\":
{\"5da721852337c25acecc3922\":
\"<a href="mongodb://sydleone:sydleonep101@VMPRDDB-ESCMONGO01:27017,VMPRDDB-ESCMONGO02:27017/?connectTimeoutMS=300000">mongodb://sydleone:sydleonep101\@VMPRDDB-ESCMONGO01:27017,VMPRDDB-ESCMONGO02:27017/?connectTimeoutMS=300000</a>\"}})</p>
<p>db.getCollection(\'000000002337c25acecc38cc\').update({\"_id\" :
ObjectId(\"000000000000000221111111\")},{\"\$set\":
{\"5da71e5b2337c25acecc38c0\": \"cluster-sydleone\"}})</p>
<p>db.getCollection(\'000000002337c25acecc38cc\').update({\"_id\" :
ObjectId(\"000000000000000221111111\")},{\"\$set\":
{\"5da71e912337c25acecc38c4\": [ \"<a href="http://VMPRDAPP-ESCELA01:9200">http://VMPRDAPP-ESCELA01:9200</a>\",
\"<a href="http://VMPRDAPP-ESCELA02:9200">http://VMPRDAPP-ESCELA02:9200</a>\", \"<a href="http://VMPRDAPP-ESCELA03:9200">http://VMPRDAPP-ESCELA03:9200</a>\"
]}})</p>
<ol>
<li>Desabilitar organização</li>
</ol>
<p>db.getCollection(\'000000000000000000000333\').updateOne({</p>
<p><code>_id: ObjectId('5d122d72727e59522b60c339')</code></p>
<p>},{</p>
<p><code>$set: {</code>\
<code>"5d9f5cf5f5730067840dc3c3" : false</code>\
<code>}</code></p>
<p>}) <code>&lt;/code&gt;</code>{=html}</p>
<p>9 - Iniciar a aplicação Java em ** VMPRDAPP-ESC01, VMPRDAPP-ESC02,
VMPRDAPP-ESC03, VMPRDAPP-ESC04 **</p>
<p><code>&lt;code bash&gt;</code>{=html}</p>
<ol>
<li>systemctl start tomcat8</li>
</ol>
<p><code>&lt;/code&gt;</code>{=html}</p>
<p>10 - Alteração de registros DNS</p>
<p><code>* pmcdigital.curitiba.pr.gov.br ⇒ 172.31.10.17</code>\
<code>* pmcdigital.curitiba.pr.gov.br ⇒ 177.125.179.67</code>\
<code>* servicodigital.curitiba.pr.gov.br ⇒ 172.31.10.17</code>\
<code>* servicodigital.curitiba.pr.gov.br ⇒ 177.125.179.67</code>\
<code>* servicodigitalservidor.curitiba.pr.gov.br ⇒ 172.31.10.17</code>\
<code>* servicodigitalservidor.curitiba.pr.gov.br ⇒ 177.125.179.67</code></p>
<h5 id="troubleshooting">Troubleshooting</h5>
<p><a href="http://server:8080/system/sys/admin" title="wikilink"><a href="http://server:8080/system/sys/admin">http://server:8080/system/sys/admin</a></a></p>
<p>\\</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
