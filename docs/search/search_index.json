{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Welcome to MkDocs For full documentation visit mkdocs.org . Commands mkdocs new [dir-name] - Create a new project. mkdocs serve - Start the live-reloading docs server. mkdocs build - Build the documentation site. mkdocs -h - Print help message and exit. Project layout mkdocs.yml # The configuration file. docs/ index.md # The documentation homepage. ... # Other markdown pages, images and other files.","title":"Index"},{"location":"#welcome-to-mkdocs","text":"For full documentation visit mkdocs.org .","title":"Welcome to MkDocs"},{"location":"#commands","text":"mkdocs new [dir-name] - Create a new project. mkdocs serve - Start the live-reloading docs server. mkdocs build - Build the documentation site. mkdocs -h - Print help message and exit.","title":"Commands"},{"location":"#project-layout","text":"mkdocs.yml # The configuration file. docs/ index.md # The documentation homepage. ... # Other markdown pages, images and other files.","title":"Project layout"},{"location":"teste/","text":"Infraestrutura Segue abaixo documenta\u00e7\u00e3o da nova infraestrutura em Cluster. **Desenvolvimento** |**SERVIDOR** |**ENDERE\u00c7O IP** |**FUN\u00c7\u00c3O** |**CPU** |**RAM** |**DISCO** | |VMHOMAPP-ESC01|172.31.22.4|Frontend/backend/NFS|4|16 GB|S.O +100 GB| |VMHOMAPP-ESC02|172.31.22.5|Frontend/backend|4|16 GB|S.O + 30 GB| |VMHOMAPP-ESC03|172.31.22.6|sys (controle)|2|4 GB|S.O + 30 GB| |VMHOMAPP-ESC04|172.31.22.7|sys (controle)|2|4 GB|S.O + 30 GB| |VMHOMAPP-ESCELA01|172.31.22.8|Elastic|4|16 GB|S.O + 100 GB| |VMHOMAPP-ESCELA02|172.31.22.9|Elastic|4|16 GB|S.O + 100 GB| |VMHOMAPP-ESCELA03|172.31.22.10|Elastic|4|16 GB|S.O + 100 GB| |VMHOMDB-ESCMONGO01|172.31.22.11|Database|4|16 GB|S.O + 100 GB| |VMHOMDB-ESCMONGO02|172.31.22.12|Database|4|16 GB|S.O + 100 GB| |VMHOMDB-ESCMONGO03|172.31.22.13|Database|2|4 GB|S.O + 100 GB| **Produ\u00e7\u00e3o** |**SERVIDOR** |**ENDERE\u00c7O IP** |**FUN\u00c7\u00c3O** |**CPU** |**RAM** |**DISCO** | |VMPRDAPP-ESC01|172.31.24.4|Frontend/backend|8|32 GB|S.O + 50 GB| |VMPRDAPP-ESC02|172.31.24.5|Frontend/backend|8|32 GB|S.O + 50 GB| |VMPRDAPP-ESC03|172.31.24.6|sys (controle)|2|4 GB|S.O + 50 GB| |VMPRDAPP-ESC04|172.31.24.7|sys (controle)|2|4 GB|S.O + 50 GB| |VMPRDAPP-ESCELA01|172.31.24.8|Elastic|8|16 GB|S.O + 150 GB| |VMPRDAPP-ESCELA02|172.31.24.9|Elastic|8|16 GB|S.O + 150 GB| |VMPRDAPP-ESCELA03|172.31.24.10|Elastic|8|16 GB|S.O + 150 GB| |VMPRDDB-ESCMONGO01|172.31.24.11|Database|4|16 GB|S.O + 350 GB| |VMPRDDB-ESCMONGO02|172.31.24.12|Database|4|16 GB|S.O + 750 GB| |VMPRDDB-ESCMONGO03|172.31.24.13|Database|2|4 GB|S.O + 200 GB| |VMPRDAPP-ESCFILES|172.31.24.14|Armazenmento de arquivos NFS|4|4 GB|S.O + 1.5 TB| URL Desenvolvimento** https://devservicodigital.curitiba.pr.gov.br \\\\ https://homservicodigital.curitiba.pr.gov.br \\\\ https://dev-pmcdigital.curitiba.pr.gov.br \\\\ https://hom-pmcdigital.curitiba.pr.gov.br Produ\u00e7\u00e3o** https://servicodigital.curitiba.pr.gov.br \\\\ https://servicodigitalservidor.curitiba.pr.gov.br \\\\ https://pmcdigital.curitiba.pr.gov.br Elasticsearch Documenta\u00e7\u00e3o da instala\u00e7\u00e3o do cluster Elasticsearch executada em conjunto com o Analista Eduardo da empresa Sydle no dia **19/05/2022** OBS**: Efetuamos a instala\u00e7\u00e3o juntamente com a Sydle, seguindo as boas praticas e recomenda\u00e7\u00f5es repassadas em videoconfer\u00eancia. Segue em anexo documenta\u00e7\u00e3o original encaminhada por e-mail \u21d2 {{:linux:solucoes:install_elasticsearch.txt|install_elasticsearch.txt}} {=mediawiki} Hardware utilizado seguindo a recomenda\u00e7\u00e3o da Sydle * 4 x Intel(R) Xeon(R) Platinum 8160 CPU @ 2.10GHz \\ * 16 GB Mem\u00f3ria RAM \\ * 30 GB sistema operacional / 100 GB para o diret\u00f3rio /var/lib/elasticsearch OBS**: configura\u00e7\u00e3o sugerida n\u00e3o foi suficiente, sendo necess\u00e1rio upgrade. Consulte o menu infraestrutura Os passos para prepara\u00e7\u00e3o do ambiente, instala\u00e7\u00e3o e configura\u00e7\u00e3o devem ser executadas nos tr\u00eas servidores simultaneamente <code bash> {=html} Ajustes S.O vim /etc/security/limits.conf elasticsearch - nofile 999999 elasticsearch soft memlock unlimited elasticsearch hard memlock unlimited vim /etc/sysctl.conf vm.max_map_count=262144 vm.swappiness = 1 sysctl -p sed -i \\'s/SELINUX=enforcing/SELINUX=disabled/g\\' /etc/selinux/config Instala\u00e7\u00e3o>> arquivos dispon\u00edveis no owncloud>> Solu\u00e7\u00f5es Tecnicas\\Servers Linux\\Sydle rpm -ivh jdk-11.0.15_linux-x64_bin.rpm rpm -ivh elasticsearch-7.6.2-x86_64.rpm chown -R elasticsearch.elasticsearch /var/lib/elasticsearch vim /usr/lib/systemd/system/elasticsearch.service LimitNOFILE=999999 LimitNPROC=65536 LimitMEMLOCK=infinity systemctl daemon-reload systemctl enable elasticsearch.service Editar configura\u00e7\u00e3o do Elasticsearch em todos os nodes -- (Exemplo) cat /etc/elasticsearch/elasticsearch.yml cluster.name: sydleone-cluster-hom node.name: VMHOMAPP-ESCELA01 node.master: true node.data: true node.ingest: false bootstrap.memory_lock: true network.host: VMHOMAPP-ESCELA01 http.port: 9200 transport.tcp.port: 9300 discovery.zen.ping.unicast.hosts: [\\\"VMHOMAPP-ESCELA01\\\",\\\"VMHOMAPP-ESCELA02\\\",\\\"VMHOMAPP-ESCELA03\\\"] action.destructive_requires_name: false bootstrap.system_call_filter: false action.auto_create_index: \\\".watches,.triggered_watches,.watcher-history-*\\\" path.logs: /var/log/elasticsearch path.data: /var/lib/elasticsearch cluster.initial_master_nodes: VMHOMAPP-ESCELA01, VMHOMAPP-ESCELA02, VMHOMAPP-ESCELA03 discovery.zen.minimum_master_nodes: 2 gateway.recover_after_nodes: 2 gateway.expected_nodes: 3 gateway.recover_after_time: 10m http.max_initial_line_length : 10mb cluster.routing.allocation.disk.threshold_enabled: true cluster.routing.allocation.disk.watermark.low: \\\"90%\\\" cluster.routing.allocation.disk.watermark.high: \\\"95%\\\" cluster.routing.allocation.disk.watermark.flood_stage: \\\"99%\\\" indices.query.bool.max_clause_count: 3000 vim /etc/elasticsearch/jvm.options Xms represents the initial size of total heap space Xmx represents the maximum size of total heap space -Xms11g -Xmx11g G1GC Configuration NOTE: G1 GC is only supported on JDK version 10 or later to use G1GC, uncomment the next two lines and update the version on the following three lines to your version of the JDK 10-13:-XX:-UseConcMarkSweepGC 10-13:-XX:-UseCMSInitiatingOccupancyOnly 11-:-XX: UseG1GC 11-:-XX:G1ReservePercent=25 11-:-XX:InitiatingHeapOccupancyPercent=30 CVE-2021-44228 (log4j2) -Dlog4j2.formatMsgNoLookups=true Iniciar servi\u00e7o em todos os nodes systemctl start elasticsearch.service Alterar parametros persistentes no node VMHOMAPP-ESCELA01 curl -H \\'Content-Type: application/json\\' -XPUT \\\" http://$HOSTNAME:9200/_cluster/settings \\\" -d \\'{ \"persistent\": { \\ \"cluster.routing.allocation.node_concurrent_incoming_recoveries\": \"20\", \\ \"cluster.routing.allocation.cluster_concurrent_rebalance\": \"20\", \\ \"cluster.routing.allocation.node_concurrent_recoveries\": \"20\", \\ \"cluster.routing.allocation.node_initial_primaries_recoveries\": \"40\", \\ \"cluster.routing.allocation.node_concurrent_outgoing_recoveries\": \"20\", \\ \"cluster.max_shards_per_node\": \"30000\", \\ \"indices.recovery.max_bytes_per_sec\": \"100mb\", \\ \"action.search.shard_count.limit\": \"3000\", \\ \"search.max_buckets\": 100000, \\ \"cluster.routing.allocation.disk.threshold_enabled\": \"true\", \\ \"cluster.routing.allocation.disk.watermark.low\": \"90%\", \\ \"cluster.routing.allocation.disk.watermark.high\": \"95%\", \\ \"cluster.routing.allocation.disk.watermark.flood_stage\": \"99%\" \\ } }\\' Testar servi\u00e7o no node VMHOMAPP-ESCELA01 [root\\@VMHOMAPP-ESCELA01 \\~]# curl \\\"\\$HOSTNAME\\\":9200 { \"name\" : \"VMHOMAPP-ESCELA01\", \\ \"cluster_name\" : \"sydleone-cluster-hom\", \\ \"cluster_uuid\" : \"fUju0zLpQ5yLiaSUsfEj5w\", \\ \"version\" : { \\ \"number\" : \"7.6.2\", \\ \"build_flavor\" : \"default\", \\ \"build_type\" : \"rpm\", \\ \"build_hash\" : \"ef48eb35cf30adf4db14086e8aabd07ef6fb113f\", \\ \"build_date\" : \"2020-03-26T06:34:37.794943Z\", \\ \"build_snapshot\" : false, \\ \"lucene_version\" : \"8.4.0\", \\ \"minimum_wire_compatibility_version\" : \"6.8.0\", \\ \"minimum_index_compatibility_version\" : \"6.0.0-beta1\" \\ }, \\ \"tagline\" : \"You Know, for Search\" } root\\@VMHOMAPP-ESCELA01 \\~]# curl \\\"\\$HOSTNAME\\\":9200/_cat/nodes?v ip heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name 172.19.208.227 4 75 0 0.00 0.01 0.05 dlm * VMHOMAPP-ESCELA02 172.19.208.234 3 75 0 0.00 0.01 0.05 dlm - VMHOMAPP-ESCELA03 172.19.210.225 3 75 0 0.00 0.01 0.05 dlm - VMHOMAPP-ESCELA01 [root\\@VMHOMAPP-ESCELA01 \\~]# curl \\\"\\$HOSTNAME\\\":9200/_cat/health 1652985296 18:34:56 sydleone-cluster-hom green 3 3 0 0 0 0 0 0 - 100.0% </code> {=html} O elasticsearch funciona atrav\u00e9s das portas **TCP 9200 e 9300** Visualizar tamanho dos indices** curl ' http://172.31.31.199:9200/_cat/indices/?pretty&s=store.size:desc ' | more Tomcat Documenta\u00e7\u00e3o da instala\u00e7\u00e3o do webserver Tomcat executada em conjunto com o Analista Eduardo Legatti da empresa Sydle no dia **24/05/2022** OBS**: Efetuamos a instala\u00e7\u00e3o juntamente com a Sydle, seguindo as boas praticas e recomenda\u00e7\u00f5es repassadas em videoconfer\u00eancia. <code bash> {=html} Java /usr/local/jdk1.8.0_202 Tomcat /usr/local/apache-tomcat-8.5.79 Link Simb\u00f3lico ls -l /usr/local/ lrwxrwxrwx 1 root root 12 May 24 14:15 jdk8 -> jdk1.8.0_202 lrwxrwxrwx 1 deployer deployer 20 May 24 14:16 tomcat8 -> apache-tomcat-8.5.79 script inicializa\u00e7\u00e3o vim /etc/init.d/tomcat8 chmod x /etc/init.d/tomcat8 chkconfig tomcat8 on Remo\u00e7\u00e3o de todas as aplica\u00e7\u00f5es default rm -rf /usr/local/tomcat8/webapps/* </code> {=html} <code bash> {=html} Configura\u00e7\u00f5es efetuada no arquivo /usr/local/tomcat8/bin/catalina.sh Servidores VMHOMAPP-ESC01 e VMHOMAPP-ESC02 JAVA_HOME=/usr/local/jdk8 CATALINA_OPTS=\\\"-server -Xms12000M -Xmx12000M -XX: UseStringDeduplication -XX: UseG1GC -XX:MaxGCPauseMillis=200 -XX:ParallelGCThreads=4 -XX:ConcGCThreads=4 -XX:InitiatingHeapOccupancyPercent=60 -Dfile.encoding=ISO8859_1 -Dmail.encoding=ISO8859_1 -Djava.awt.headless=true -Djava.rmi.server.hostname=172.19.210.212 -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=8010 -Dcom.sun.management.jmxremote.local.only=false -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false\\\" </code> {=html} <code bash> {=html} Configura\u00e7\u00f5es efetuada no arquivo /usr/local/tomcat8/bin/catalina.sh Servidores VMHOMAPP-ESC03 e VMHOMAPP-ESC04 JAVA_HOME=/usr/local/jdk8 CATALINA_OPTS=\\\"-server -Xms3000M -Xmx3000M -XX: UseStringDeduplication -XX: UseG1GC -XX:MaxGCPauseMillis=200 -XX:ParallelGCThreads=4 -XX:ConcGCThreads=4 -XX:InitiatingHeapOccupancyPercent=60 -Dfile.encoding=ISO8859_1 -Dmail.encoding=ISO8859_1 -Djava.awt.headless=true -Djava.rmi.server.hostname=172.19.210.212 -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=8010 -Dcom.sun.management.jmxremote.local.only=false -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false\\\" </code> {=html} NFS Montar NFS para armazenamento dos dados nos 4 servidores Tomcat =\u21d2 /sydleone * DEV = Usar a mesma infraestrutura de DEV \\ * PRD = Servidor dedicado NFS Criando espa\u00e7o especifico para armazenamento dos dados ** <code bash> {=html} chmod x rescan_lun_scsi.sh ./rescan_lun_scsi.sh parted /dev/sdb vgcreate vg_sydle /dev/sdb1 lvcreate -l 100%FREE -n lv_sydle vg_sydle mkfs.xfs /dev/mapper/vg_sydle-lv_sydle mkdir /sydleone <!-- --> vim /etc/fstab /dev/mapper/vg_sydle-lv_sydle /sydleone xfs defaults 0 0 </code> {=html} Instala\u00e7\u00e3o e configura\u00e7\u00e3o NFS ** <code bash> {=html} yum install nfs-utils rpcbind systemctl start rpcbind systemctl start nfs-server systemctl start nfs-lock systemctl start nfs-idmap systemctl status nfs <!-- --> chmod -R 755 /sydleone/ chown nfsnobody:nfsnobody /sydleone/ <!-- --> vim /etc/exports /sydleone 172.19.210.214(rw,sync) /sydleone 172.19.210.221(rw,sync) /sydleone 172.19.210.224(rw,sync) exportfs systemctl restart nfs-server <!-- --> showmount -e VMHOMAPP-ESC01 Export list for VMHOMAPP-ESC01: /sydleone 172.19.210.224,172.19.210.221,172.19.210.214 </code> {=html} Agora no cliente (m\u00e1quina que ir\u00e1 montar o compartilhamento feito anteriormente) execute: <code bash> {=html} yum install nfs-utils usermod -a -G nfsnobody deployer mkdir /sydleone chown nfsnobody:nfsnobody /sydleone/ mount -t nfs vmhomapp-esc01:/sydleone /sydleone <!-- --> vim /etc/fstab vmhomapp-esc01:/sydleone /sydleone nfs defaults 0 0 </code> {=html} Apache httpd {#apache_httpd} Os procedimentos devem ser executados em **VMPRDAPP-ESC01** e **VMPRDAPP-ESC02** <code bash> {=html} yum install httpd -y systemctl enable --now httpd rm -rf /usr/share/httpd/noindex/* <!-- --> vim /etc/httpd/conf/httpd.conf <!-- --> TIMEZONE SetEnv TZ America/Sao_Paulo SEGURANCA ServerSignature Off ServerTokens Prod TraceEnable Off </code> {=html} Configura\u00e7\u00e3o portal servicodigital.curitiba.pr.gov.br <code bash> {=html} cat /etc/httpd/conf.d/portal-pmcdigital.conf \\ ServerName servicodigital.curitiba.pr.gov.br \\ ServerAlias servicodigitalinterno.curitiba.pr.gov.br \\ DocumentRoot /var/www/portal-pmcdigital-pmc-prd \\ RemoteIPHeader X-Forwarded-For ``<Directory /var/www/portal-pmcdigital-pmc-prd> {=html}\\ Options Indexes FollowSymLinks \\ Require all granted \\ AllowOverride All \\ ``</Directory> {=html} </VirtualHost> {=html} </code> {=html} Configura\u00e7\u00e3o portal servicodigitalservidor.curitiba.pr.gov.br <code bash> {=html} cat /etc/httpd/conf.d/servicodigitalservidor.conf \\ ServerName servicodigitalservidor.curitiba.pr.gov.br \\ ServerAlias int-servicodigitalservidor.curitiba.pr.gov.br \\ DocumentRoot /var/www/portal-pub-pmcdigital-pmc-prd \\ RemoteIPHeader X-Forwarded-For ``<Directory /var/www/portal-pub-pmcdigital-pmc-prd> {=html}\\ Options Indexes FollowSymLinks \\ Require all granted \\ AllowOverride All \\ ``</Directory> {=html} </VirtualHost> {=html} </code> {=html} Efetuando **backup** dos portais em **VMPRDAPP-ESCPROC** <code bash> {=html} cd /var/www tar -zcvf /root/backup.tar.gz portal-pmcdigital-pmc-prd portal-pub-pmcdigital-pmc-prd </code> {=html} Restore dos arquivos em **VMPRDAPP-ESC01** e **VMPRDAPP-ESC02** <code bash> {=html} cd /var/www tar -zxvf backup.tar.gz rm -f backup.tar.gz </code> {=html} Load Balance {#load_balance} Executar configura\u00e7\u00f5es em **LBHASOLUTION1** e **LBHASOLUTION2** <code bash> {=html} cat /etc/haproxy/haproxy.cfg use_backend pmcdigital.curitiba.pr.gov.br if { hdr_dom(host) -i pmcdigital.curitiba.pr.gov.br } \\ use_backend servicodigital.curitiba.pr.gov.br if { hdr_dom(host) -i servicodigital.curitiba.pr.gov.br } \\ use_backend servicodigitalservidor.curitiba.pr.gov.br if { hdr_dom(host) -i servicodigitalservidor.curitiba.pr.gov.br } backend pmcdigital.curitiba.pr.gov.br option httpchk HEAD / HTTP/1.1\\r\\nHost: pmcdigital.curitiba.pr.gov.br http-check expect status 200 \\ server server01 vmprdapp-esc01.curitiba.pr.gov.br:8080 weight 1 maxconn 200 \\ server server02 vmprdapp-esc02.curitiba.pr.gov.br:8080 weight 1 maxconn 200 backend servicodigital.curitiba.pr.gov.br option httpchk HEAD / HTTP/1.1\\r\\nHost: servicodigital.curitiba.pr.gov.br \\ http-check expect status 200 \\ server server01 vmprdapp-esc01.curitiba.pr.gov.br:80 weight 1 maxconn 200 \\ server server02 vmprdapp-esc02.curitiba.pr.gov.br:80 weight 1 maxconn 200 backend servicodigitalservidor.curitiba.pr.gov.br option httpchk HEAD / HTTP/1.1\\r\\nHost: servicodigitalservidor.curitiba.pr.gov.br \\ http-check expect status 200 \\ server server01 vmprdapp-esc01.curitiba.pr.gov.br:80 weight 1 maxconn 200 \\ server server02 vmprdapp-esc02.curitiba.pr.gov.br:80 weight 1 maxconn 200 </code> {=html} Gest\u00e3o de mudan\u00e7a {#gest\u00e3o_de_mudan\u00e7a} Resumo Ser\u00e1 necess\u00e1rio alterar apontamento do proxy reverso. A infraestrutura standalone esta hospedada na solu\u00e7\u00e3o nginx (**vmprdprx-web**) <code bash> {=html} Sydle Java pmcdigital.curitiba.pr.gov.br [172.31.10.40] => ep.curitiba.pr.gov.br:8443 [172.31.31.180] Sydle PHP servicodigital.curitiba.pr.gov.br [172.31.10.40] => servicodigitalinterno.curitiba.pr.gov.br [172.31.31.180] servicodigitalservidor.curitiba.pr.gov.br [172.31.10.40] => int-servicodigitalservidor.curitiba.pr.gov.br [172.31.31.180] </code> {=html} A nova infraestrutura ser\u00e1 hospedada no Haproxy (**LBHASOLUTION**) <code bash> {=html} Sydle Java pmcdigital.curitiba.pr.gov.br [172.31.10.17] => vmprdapp-esc01.curitiba.pr.gov.br:8080 [172.31.24.4] pmcdigital.curitiba.pr.gov.br [172.31.10.17] => vmprdapp-esc02.curitiba.pr.gov.br:8080 [172.31.24.5] Sydle PHP servicodigital.curitiba.pr.gov.br [172.31.10.17] => vmprdapp-esc01.curitiba.pr.gov.br:80 [172.31.24.4] servicodigitalservidor.curitiba.pr.gov.br [172.31.10.17] => vmprdapp-esc01.curitiba.pr.gov.br:80 [172.31.24.5] </code> {=html} Procedimento Operacional {#procedimento_operacional} Procedimentos a serem executados na **infraestrutura standalone** 2 - Desabilitar Organiza\u00e7\u00e3o \\\\ 3 - Parar Tomcat VMPRDAPP-ESCPROC, VMPRDAPP-ESC01, VMPRDAPP-ESC02 \\\\ 4 - Parar MongoDB \\\\ 5 - Parar Elastic \u21d2 [root\\@VMPRDAPP-INDEX \\~]# systemctl stop elasticsearch \\\\ 6 - Replica\u00e7\u00e3o dos arquivos /sydleone <code bash> {=html} [root\\@VMPRDAPP-ESCPROC \\~]# rsync /sydleone/ -arvz -e \\'ssh -p 6293\\' --progress --delete root\\@vmprdapp-escfiles.curitiba.pr.gov.br:/sydleone/ [root\\@VMPRDAPP-ESCFILES \\~]# chown -R nfsnobody:nfsnobody /sydleone/ ; chmod -R 775 /sydleone/ </code> {=html} 7 - Replica\u00e7\u00e3o Elastic 7.1 - Apagar todos os \u00edndices da estrutura nova [ **VMPRDAPP-ESCELA01, VMPRDAPP-ESCELA02, VMPRDAPP-ESCELA03** ] <code bash> {=html} systemctl stop elasticsearch rm -rf /var/lib/elasticsearch/* </code> {=html} 7.2 - Replica\u00e7\u00e3o dados **VMPRDAPP-INDEX \u21d2 VMPRDAPP-ESCELA01** <code bash> {=html} Replica [root\\@VMPRDAPP-INDEX \\~]# rsync /var/lib/elasticsearch/ -arvz -e \\'ssh -p 6293\\' --progress --delete root\\@vmprdapp-escela01.curitiba.pr.gov.br:/var/lib/elasticsearch/ Corre\u00e7\u00e3o Permiss\u00f5es [root\\@VMPRDAPP-ESCELA01 \\~]# chown -R elasticsearch.elasticsearch /var/lib/elasticsearch [root\\@VMPRDAPP-ESCELA01 \\~]# rm -f /var/lib/elasticsearch/nodes/0/node.lock [root\\@VMPRDAPP-ESCELA01 \\~]# rm -f /var/lib/elasticsearch/nodes/0/_state </code> {=html} 7.3 - Iniciar Elastic / Valida\u00e7\u00e3o <code bash> {=html} [root\\@VMPRDAPP-ESCELA01 \\~]# systemctl start elasticsearch [root\\@VMPRDAPP-ESCELA02 \\~]# systemctl start elasticsearch [root\\@VMPRDAPP-ESCELA03 \\~]# systemctl start elasticsearch [root\\@VMPRDAPP-ESCELA01 \\~]# curl \\\" http://172.31.24.8:9200/_cat/health \\\" </code> {=html} 7.4 - Cria\u00e7\u00e3o de replicas <code bash> {=html} [root\\@VMPRDAPP-ESCELA01 \\~]# curl -H \\'Content-Type: application/json\\' -XPUT \\\" http://$HOSTNAME:9200/*5d122d72727e59522b60c339 .*/_settings\\\" -d \\'{\\\"index\\\" : {\\\"number_of_replicas\\\" : 1}}\\' [root\\@VMPRDAPP-ESCELA01 \\~]# curl -H \\'Content-Type: application/json\\' -XPUT \\\" http://$HOSTNAME:9200/*000000000000111111111111 .*/_settings\\\" -d \\'{\\\"index\\\" : {\\\"number_of_replicas\\\" : 1}}\\' Valida\u00e7\u00e3o [root\\@VMPRDAPP-ESCELA01 \\~]# curl \\\" http://172.31.24.8:9200/_cat/allocation \\\" [root\\@VMPRDAPP-ESCELA01 \\~]# curl \\\" http://172.31.24.8:9200/_cat/indices/ *?h=index,pri,rep,docs.count,docs.deleted,pri.store.size&s=pri.store.size:desc&v\\\" [root\\@VMPRDAPP-ESCELA01 \\~]# curl \\\" http://172.31.24.8:9200/_cat/health \\\" </code> {=html} 8 - Migra\u00e7\u00e3o banco de dados MongoDB 8.1 - Parar servi\u00e7o do mongodb nos servidores **VMPRDAPP-ECM (172.31.31.181), VMPRDAPP-ESCPROCRPL (172.31.31.183), VMPRDAPP-ESCPROC (172.31.31.180)** su - mongodb mongo --port 27017 --username \"admin\" --password \"########\" --authenticationDatabase \"admin\" use admin db.shutdownServer() 8.2 Copiar os bin\u00e1rios e remover dados desatualizados nos servidores **VMPRDDB-ESCMONGO01, VMPRDDB-ESCMONGO02, VMPRDDB-ESCMONGO03** cp -Ra /data/mongodb/mongodb-linux-x86_64-rhel70-4.2.17/ /data/ (temporariamente) rm -rf /data/mongodb/* 8.3 - Replicar dados <code bash> {=html} Iniciar a c\u00f3pia dentro do servidor VMPRDAPP-ESCPROCRPL (172.31.31.183) time rsync -av --delete -e \\'ssh -p 6293\\' /mongodb/data/* root\\@10.0.0.19:/data/mongodb Devolver o diret\u00f3rio /data/mongodb/mongodb-linux-x86_64-rhel70-4.2.17/ para o /data/mongodb (servidores ESCMONGO) mv /data/mongodb-linux-x86_64-rhel70-4.2.17/ /data/mongodb/ Iniciar o servi\u00e7o no n\u00f3 Prim\u00e1rio (VMPRDDB-ESCMONGO01) su - mongodb mongod --fork --config /etc/mongod.conf Conectar no MongoDB mongo --port 27017 --username \\\"admin\\\" --password \\\"########\\\" --authenticationDatabase \\\"admin\\\" Refazer a configura\u00e7\u00e3o do replicaset cfg = {_id: \\'sdlPrdSet\\', members: [ {_id: 0, host: 'vmprddb-escmongo01:27017'}, \\ {_id: 1, host: 'vmprddb-escmongo02:27017'}, \\ {_id: 2, host: 'vmprddb-escmongo03:27017', arbiterOnly: true}] } rs.reconfig(cfg, {force: true}); Acessar os servidores VMPRDDB-ESCMONGO02 e VMPRDDB-ESCMONGO03 e iniciar os servi\u00e7os mv /data/mongodb-linux-x86_64-rhel70-4.2.17/ /data/mongodb/ su - mongodb mongod --fork --config /etc/mongod.conf Alterar a prioridade do secondary para fazer failback autom\u00e1tico caso o n\u00f3 1 caia e volte depois cfg = rs.conf(); cfg.members[1].priority = 0.5; rs.reconfig(cfg); Obs.: Durante a c\u00f3pia para o servidor secund\u00e1rio, o status ficar\u00e1 sdlPrdSet:STARTUP2 <!-- --> Ap\u00f3s a c\u00f3pia dos dados, fazer as altera\u00e7\u00f5es nas bases escmongo (usando o n\u00f3 prim\u00e1rio) use 000000000000111111111111 db.getCollection(\\'000000002337c25acecc394e\\').update({\\\"_id\\\" : ObjectId(\\\"000000000000000331111111\\\")},{\\\"\\$set\\\": {\\\"5da721852337c25acecc3922\\\": \\\" mongodb://sydleone:sydleonep101\\@VMPRDDB-ESCMONGO01:27017,VMPRDDB-ESCMONGO02:27017/?connectTimeoutMS=300000 \\\"}}) db.getCollection(\\'000000002337c25acecc38cc\\').update({\\\"_id\\\" : ObjectId(\\\"000000000000000221111111\\\")},{\\\"\\$set\\\": {\\\"5da71e5b2337c25acecc38c0\\\": \\\"cluster-sydleone\\\"}}) db.getCollection(\\'000000002337c25acecc38cc\\').update({\\\"_id\\\" : ObjectId(\\\"000000000000000221111111\\\")},{\\\"\\$set\\\": {\\\"5da71e912337c25acecc38c4\\\": [ \\\" http://VMPRDAPP-ESCELA01:9200 \\\", \\\" http://VMPRDAPP-ESCELA02:9200 \\\", \\\" http://VMPRDAPP-ESCELA03:9200 \\\" ]}}) Desabilitar organiza\u00e7\u00e3o db.getCollection(\\'000000000000000000000333\\').updateOne({ _id: ObjectId('5d122d72727e59522b60c339') },{ $set: { \\ \"5d9f5cf5f5730067840dc3c3\" : false \\ } }) </code> {=html} 9 - Iniciar a aplica\u00e7\u00e3o Java em ** VMPRDAPP-ESC01, VMPRDAPP-ESC02, VMPRDAPP-ESC03, VMPRDAPP-ESC04 ** <code bash> {=html} systemctl start tomcat8 </code> {=html} 10 - Altera\u00e7\u00e3o de registros DNS * pmcdigital.curitiba.pr.gov.br \u21d2 172.31.10.17 \\ * pmcdigital.curitiba.pr.gov.br \u21d2 177.125.179.67 \\ * servicodigital.curitiba.pr.gov.br \u21d2 172.31.10.17 \\ * servicodigital.curitiba.pr.gov.br \u21d2 177.125.179.67 \\ * servicodigitalservidor.curitiba.pr.gov.br \u21d2 172.31.10.17 \\ * servicodigitalservidor.curitiba.pr.gov.br \u21d2 177.125.179.67 Troubleshooting http://server:8080/system/sys/admin \\\\","title":"Teste"},{"location":"teste/#infraestrutura","text":"Segue abaixo documenta\u00e7\u00e3o da nova infraestrutura em Cluster. **Desenvolvimento** |**SERVIDOR** |**ENDERE\u00c7O IP** |**FUN\u00c7\u00c3O** |**CPU** |**RAM** |**DISCO** | |VMHOMAPP-ESC01|172.31.22.4|Frontend/backend/NFS|4|16 GB|S.O +100 GB| |VMHOMAPP-ESC02|172.31.22.5|Frontend/backend|4|16 GB|S.O + 30 GB| |VMHOMAPP-ESC03|172.31.22.6|sys (controle)|2|4 GB|S.O + 30 GB| |VMHOMAPP-ESC04|172.31.22.7|sys (controle)|2|4 GB|S.O + 30 GB| |VMHOMAPP-ESCELA01|172.31.22.8|Elastic|4|16 GB|S.O + 100 GB| |VMHOMAPP-ESCELA02|172.31.22.9|Elastic|4|16 GB|S.O + 100 GB| |VMHOMAPP-ESCELA03|172.31.22.10|Elastic|4|16 GB|S.O + 100 GB| |VMHOMDB-ESCMONGO01|172.31.22.11|Database|4|16 GB|S.O + 100 GB| |VMHOMDB-ESCMONGO02|172.31.22.12|Database|4|16 GB|S.O + 100 GB| |VMHOMDB-ESCMONGO03|172.31.22.13|Database|2|4 GB|S.O + 100 GB| **Produ\u00e7\u00e3o** |**SERVIDOR** |**ENDERE\u00c7O IP** |**FUN\u00c7\u00c3O** |**CPU** |**RAM** |**DISCO** | |VMPRDAPP-ESC01|172.31.24.4|Frontend/backend|8|32 GB|S.O + 50 GB| |VMPRDAPP-ESC02|172.31.24.5|Frontend/backend|8|32 GB|S.O + 50 GB| |VMPRDAPP-ESC03|172.31.24.6|sys (controle)|2|4 GB|S.O + 50 GB| |VMPRDAPP-ESC04|172.31.24.7|sys (controle)|2|4 GB|S.O + 50 GB| |VMPRDAPP-ESCELA01|172.31.24.8|Elastic|8|16 GB|S.O + 150 GB| |VMPRDAPP-ESCELA02|172.31.24.9|Elastic|8|16 GB|S.O + 150 GB| |VMPRDAPP-ESCELA03|172.31.24.10|Elastic|8|16 GB|S.O + 150 GB| |VMPRDDB-ESCMONGO01|172.31.24.11|Database|4|16 GB|S.O + 350 GB| |VMPRDDB-ESCMONGO02|172.31.24.12|Database|4|16 GB|S.O + 750 GB| |VMPRDDB-ESCMONGO03|172.31.24.13|Database|2|4 GB|S.O + 200 GB| |VMPRDAPP-ESCFILES|172.31.24.14|Armazenmento de arquivos NFS|4|4 GB|S.O + 1.5 TB|","title":"Infraestrutura"},{"location":"teste/#url","text":"Desenvolvimento** https://devservicodigital.curitiba.pr.gov.br \\\\ https://homservicodigital.curitiba.pr.gov.br \\\\ https://dev-pmcdigital.curitiba.pr.gov.br \\\\ https://hom-pmcdigital.curitiba.pr.gov.br Produ\u00e7\u00e3o** https://servicodigital.curitiba.pr.gov.br \\\\ https://servicodigitalservidor.curitiba.pr.gov.br \\\\ https://pmcdigital.curitiba.pr.gov.br","title":"URL"},{"location":"teste/#elasticsearch","text":"Documenta\u00e7\u00e3o da instala\u00e7\u00e3o do cluster Elasticsearch executada em conjunto com o Analista Eduardo da empresa Sydle no dia **19/05/2022** OBS**: Efetuamos a instala\u00e7\u00e3o juntamente com a Sydle, seguindo as boas praticas e recomenda\u00e7\u00f5es repassadas em videoconfer\u00eancia. Segue em anexo documenta\u00e7\u00e3o original encaminhada por e-mail \u21d2 {{:linux:solucoes:install_elasticsearch.txt|install_elasticsearch.txt}} {=mediawiki} Hardware utilizado seguindo a recomenda\u00e7\u00e3o da Sydle * 4 x Intel(R) Xeon(R) Platinum 8160 CPU @ 2.10GHz \\ * 16 GB Mem\u00f3ria RAM \\ * 30 GB sistema operacional / 100 GB para o diret\u00f3rio /var/lib/elasticsearch OBS**: configura\u00e7\u00e3o sugerida n\u00e3o foi suficiente, sendo necess\u00e1rio upgrade. Consulte o menu infraestrutura Os passos para prepara\u00e7\u00e3o do ambiente, instala\u00e7\u00e3o e configura\u00e7\u00e3o devem ser executadas nos tr\u00eas servidores simultaneamente <code bash> {=html} Ajustes S.O vim /etc/security/limits.conf elasticsearch - nofile 999999 elasticsearch soft memlock unlimited elasticsearch hard memlock unlimited vim /etc/sysctl.conf vm.max_map_count=262144 vm.swappiness = 1 sysctl -p sed -i \\'s/SELINUX=enforcing/SELINUX=disabled/g\\' /etc/selinux/config Instala\u00e7\u00e3o>> arquivos dispon\u00edveis no owncloud>> Solu\u00e7\u00f5es Tecnicas\\Servers Linux\\Sydle rpm -ivh jdk-11.0.15_linux-x64_bin.rpm rpm -ivh elasticsearch-7.6.2-x86_64.rpm chown -R elasticsearch.elasticsearch /var/lib/elasticsearch vim /usr/lib/systemd/system/elasticsearch.service LimitNOFILE=999999 LimitNPROC=65536 LimitMEMLOCK=infinity systemctl daemon-reload systemctl enable elasticsearch.service Editar configura\u00e7\u00e3o do Elasticsearch em todos os nodes -- (Exemplo) cat /etc/elasticsearch/elasticsearch.yml cluster.name: sydleone-cluster-hom node.name: VMHOMAPP-ESCELA01 node.master: true node.data: true node.ingest: false bootstrap.memory_lock: true network.host: VMHOMAPP-ESCELA01 http.port: 9200 transport.tcp.port: 9300 discovery.zen.ping.unicast.hosts: [\\\"VMHOMAPP-ESCELA01\\\",\\\"VMHOMAPP-ESCELA02\\\",\\\"VMHOMAPP-ESCELA03\\\"] action.destructive_requires_name: false bootstrap.system_call_filter: false action.auto_create_index: \\\".watches,.triggered_watches,.watcher-history-*\\\" path.logs: /var/log/elasticsearch path.data: /var/lib/elasticsearch cluster.initial_master_nodes: VMHOMAPP-ESCELA01, VMHOMAPP-ESCELA02, VMHOMAPP-ESCELA03 discovery.zen.minimum_master_nodes: 2 gateway.recover_after_nodes: 2 gateway.expected_nodes: 3 gateway.recover_after_time: 10m http.max_initial_line_length : 10mb cluster.routing.allocation.disk.threshold_enabled: true cluster.routing.allocation.disk.watermark.low: \\\"90%\\\" cluster.routing.allocation.disk.watermark.high: \\\"95%\\\" cluster.routing.allocation.disk.watermark.flood_stage: \\\"99%\\\" indices.query.bool.max_clause_count: 3000 vim /etc/elasticsearch/jvm.options Xms represents the initial size of total heap space Xmx represents the maximum size of total heap space -Xms11g -Xmx11g G1GC Configuration NOTE: G1 GC is only supported on JDK version 10 or later to use G1GC, uncomment the next two lines and update the version on the following three lines to your version of the JDK 10-13:-XX:-UseConcMarkSweepGC 10-13:-XX:-UseCMSInitiatingOccupancyOnly 11-:-XX: UseG1GC 11-:-XX:G1ReservePercent=25 11-:-XX:InitiatingHeapOccupancyPercent=30 CVE-2021-44228 (log4j2) -Dlog4j2.formatMsgNoLookups=true Iniciar servi\u00e7o em todos os nodes systemctl start elasticsearch.service Alterar parametros persistentes no node VMHOMAPP-ESCELA01 curl -H \\'Content-Type: application/json\\' -XPUT \\\" http://$HOSTNAME:9200/_cluster/settings \\\" -d \\'{ \"persistent\": { \\ \"cluster.routing.allocation.node_concurrent_incoming_recoveries\": \"20\", \\ \"cluster.routing.allocation.cluster_concurrent_rebalance\": \"20\", \\ \"cluster.routing.allocation.node_concurrent_recoveries\": \"20\", \\ \"cluster.routing.allocation.node_initial_primaries_recoveries\": \"40\", \\ \"cluster.routing.allocation.node_concurrent_outgoing_recoveries\": \"20\", \\ \"cluster.max_shards_per_node\": \"30000\", \\ \"indices.recovery.max_bytes_per_sec\": \"100mb\", \\ \"action.search.shard_count.limit\": \"3000\", \\ \"search.max_buckets\": 100000, \\ \"cluster.routing.allocation.disk.threshold_enabled\": \"true\", \\ \"cluster.routing.allocation.disk.watermark.low\": \"90%\", \\ \"cluster.routing.allocation.disk.watermark.high\": \"95%\", \\ \"cluster.routing.allocation.disk.watermark.flood_stage\": \"99%\" \\ } }\\' Testar servi\u00e7o no node VMHOMAPP-ESCELA01 [root\\@VMHOMAPP-ESCELA01 \\~]# curl \\\"\\$HOSTNAME\\\":9200 { \"name\" : \"VMHOMAPP-ESCELA01\", \\ \"cluster_name\" : \"sydleone-cluster-hom\", \\ \"cluster_uuid\" : \"fUju0zLpQ5yLiaSUsfEj5w\", \\ \"version\" : { \\ \"number\" : \"7.6.2\", \\ \"build_flavor\" : \"default\", \\ \"build_type\" : \"rpm\", \\ \"build_hash\" : \"ef48eb35cf30adf4db14086e8aabd07ef6fb113f\", \\ \"build_date\" : \"2020-03-26T06:34:37.794943Z\", \\ \"build_snapshot\" : false, \\ \"lucene_version\" : \"8.4.0\", \\ \"minimum_wire_compatibility_version\" : \"6.8.0\", \\ \"minimum_index_compatibility_version\" : \"6.0.0-beta1\" \\ }, \\ \"tagline\" : \"You Know, for Search\" } root\\@VMHOMAPP-ESCELA01 \\~]# curl \\\"\\$HOSTNAME\\\":9200/_cat/nodes?v ip heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name 172.19.208.227 4 75 0 0.00 0.01 0.05 dlm * VMHOMAPP-ESCELA02 172.19.208.234 3 75 0 0.00 0.01 0.05 dlm - VMHOMAPP-ESCELA03 172.19.210.225 3 75 0 0.00 0.01 0.05 dlm - VMHOMAPP-ESCELA01 [root\\@VMHOMAPP-ESCELA01 \\~]# curl \\\"\\$HOSTNAME\\\":9200/_cat/health 1652985296 18:34:56 sydleone-cluster-hom green 3 3 0 0 0 0 0 0 - 100.0% </code> {=html} O elasticsearch funciona atrav\u00e9s das portas **TCP 9200 e 9300** Visualizar tamanho dos indices** curl ' http://172.31.31.199:9200/_cat/indices/?pretty&s=store.size:desc ' | more","title":"Elasticsearch"},{"location":"teste/#tomcat","text":"Documenta\u00e7\u00e3o da instala\u00e7\u00e3o do webserver Tomcat executada em conjunto com o Analista Eduardo Legatti da empresa Sydle no dia **24/05/2022** OBS**: Efetuamos a instala\u00e7\u00e3o juntamente com a Sydle, seguindo as boas praticas e recomenda\u00e7\u00f5es repassadas em videoconfer\u00eancia. <code bash> {=html} Java /usr/local/jdk1.8.0_202 Tomcat /usr/local/apache-tomcat-8.5.79 Link Simb\u00f3lico ls -l /usr/local/ lrwxrwxrwx 1 root root 12 May 24 14:15 jdk8 -> jdk1.8.0_202 lrwxrwxrwx 1 deployer deployer 20 May 24 14:16 tomcat8 -> apache-tomcat-8.5.79 script inicializa\u00e7\u00e3o vim /etc/init.d/tomcat8 chmod x /etc/init.d/tomcat8 chkconfig tomcat8 on Remo\u00e7\u00e3o de todas as aplica\u00e7\u00f5es default rm -rf /usr/local/tomcat8/webapps/* </code> {=html} <code bash> {=html} Configura\u00e7\u00f5es efetuada no arquivo /usr/local/tomcat8/bin/catalina.sh Servidores VMHOMAPP-ESC01 e VMHOMAPP-ESC02 JAVA_HOME=/usr/local/jdk8 CATALINA_OPTS=\\\"-server -Xms12000M -Xmx12000M -XX: UseStringDeduplication -XX: UseG1GC -XX:MaxGCPauseMillis=200 -XX:ParallelGCThreads=4 -XX:ConcGCThreads=4 -XX:InitiatingHeapOccupancyPercent=60 -Dfile.encoding=ISO8859_1 -Dmail.encoding=ISO8859_1 -Djava.awt.headless=true -Djava.rmi.server.hostname=172.19.210.212 -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=8010 -Dcom.sun.management.jmxremote.local.only=false -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false\\\" </code> {=html} <code bash> {=html} Configura\u00e7\u00f5es efetuada no arquivo /usr/local/tomcat8/bin/catalina.sh Servidores VMHOMAPP-ESC03 e VMHOMAPP-ESC04 JAVA_HOME=/usr/local/jdk8 CATALINA_OPTS=\\\"-server -Xms3000M -Xmx3000M -XX: UseStringDeduplication -XX: UseG1GC -XX:MaxGCPauseMillis=200 -XX:ParallelGCThreads=4 -XX:ConcGCThreads=4 -XX:InitiatingHeapOccupancyPercent=60 -Dfile.encoding=ISO8859_1 -Dmail.encoding=ISO8859_1 -Djava.awt.headless=true -Djava.rmi.server.hostname=172.19.210.212 -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=8010 -Dcom.sun.management.jmxremote.local.only=false -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false\\\" </code> {=html}","title":"Tomcat"},{"location":"teste/#nfs","text":"Montar NFS para armazenamento dos dados nos 4 servidores Tomcat =\u21d2 /sydleone * DEV = Usar a mesma infraestrutura de DEV \\ * PRD = Servidor dedicado NFS Criando espa\u00e7o especifico para armazenamento dos dados ** <code bash> {=html} chmod x rescan_lun_scsi.sh ./rescan_lun_scsi.sh parted /dev/sdb vgcreate vg_sydle /dev/sdb1 lvcreate -l 100%FREE -n lv_sydle vg_sydle mkfs.xfs /dev/mapper/vg_sydle-lv_sydle mkdir /sydleone <!-- --> vim /etc/fstab /dev/mapper/vg_sydle-lv_sydle /sydleone xfs defaults 0 0 </code> {=html} Instala\u00e7\u00e3o e configura\u00e7\u00e3o NFS ** <code bash> {=html} yum install nfs-utils rpcbind systemctl start rpcbind systemctl start nfs-server systemctl start nfs-lock systemctl start nfs-idmap systemctl status nfs <!-- --> chmod -R 755 /sydleone/ chown nfsnobody:nfsnobody /sydleone/ <!-- --> vim /etc/exports /sydleone 172.19.210.214(rw,sync) /sydleone 172.19.210.221(rw,sync) /sydleone 172.19.210.224(rw,sync) exportfs systemctl restart nfs-server <!-- --> showmount -e VMHOMAPP-ESC01 Export list for VMHOMAPP-ESC01: /sydleone 172.19.210.224,172.19.210.221,172.19.210.214 </code> {=html} Agora no cliente (m\u00e1quina que ir\u00e1 montar o compartilhamento feito anteriormente) execute: <code bash> {=html} yum install nfs-utils usermod -a -G nfsnobody deployer mkdir /sydleone chown nfsnobody:nfsnobody /sydleone/ mount -t nfs vmhomapp-esc01:/sydleone /sydleone <!-- --> vim /etc/fstab vmhomapp-esc01:/sydleone /sydleone nfs defaults 0 0 </code> {=html}","title":"NFS"},{"location":"teste/#apache-httpd-apache_httpd","text":"Os procedimentos devem ser executados em **VMPRDAPP-ESC01** e **VMPRDAPP-ESC02** <code bash> {=html} yum install httpd -y systemctl enable --now httpd rm -rf /usr/share/httpd/noindex/* <!-- --> vim /etc/httpd/conf/httpd.conf <!-- --> TIMEZONE SetEnv TZ America/Sao_Paulo SEGURANCA ServerSignature Off ServerTokens Prod TraceEnable Off </code> {=html} Configura\u00e7\u00e3o portal servicodigital.curitiba.pr.gov.br <code bash> {=html} cat /etc/httpd/conf.d/portal-pmcdigital.conf \\ ServerName servicodigital.curitiba.pr.gov.br \\ ServerAlias servicodigitalinterno.curitiba.pr.gov.br \\ DocumentRoot /var/www/portal-pmcdigital-pmc-prd \\ RemoteIPHeader X-Forwarded-For ``<Directory /var/www/portal-pmcdigital-pmc-prd> {=html}\\ Options Indexes FollowSymLinks \\ Require all granted \\ AllowOverride All \\ ``</Directory> {=html} </VirtualHost> {=html} </code> {=html} Configura\u00e7\u00e3o portal servicodigitalservidor.curitiba.pr.gov.br <code bash> {=html} cat /etc/httpd/conf.d/servicodigitalservidor.conf \\ ServerName servicodigitalservidor.curitiba.pr.gov.br \\ ServerAlias int-servicodigitalservidor.curitiba.pr.gov.br \\ DocumentRoot /var/www/portal-pub-pmcdigital-pmc-prd \\ RemoteIPHeader X-Forwarded-For ``<Directory /var/www/portal-pub-pmcdigital-pmc-prd> {=html}\\ Options Indexes FollowSymLinks \\ Require all granted \\ AllowOverride All \\ ``</Directory> {=html} </VirtualHost> {=html} </code> {=html} Efetuando **backup** dos portais em **VMPRDAPP-ESCPROC** <code bash> {=html} cd /var/www tar -zcvf /root/backup.tar.gz portal-pmcdigital-pmc-prd portal-pub-pmcdigital-pmc-prd </code> {=html} Restore dos arquivos em **VMPRDAPP-ESC01** e **VMPRDAPP-ESC02** <code bash> {=html} cd /var/www tar -zxvf backup.tar.gz rm -f backup.tar.gz </code> {=html}","title":"Apache httpd {#apache_httpd}"},{"location":"teste/#load-balance-load_balance","text":"Executar configura\u00e7\u00f5es em **LBHASOLUTION1** e **LBHASOLUTION2** <code bash> {=html} cat /etc/haproxy/haproxy.cfg use_backend pmcdigital.curitiba.pr.gov.br if { hdr_dom(host) -i pmcdigital.curitiba.pr.gov.br } \\ use_backend servicodigital.curitiba.pr.gov.br if { hdr_dom(host) -i servicodigital.curitiba.pr.gov.br } \\ use_backend servicodigitalservidor.curitiba.pr.gov.br if { hdr_dom(host) -i servicodigitalservidor.curitiba.pr.gov.br } backend pmcdigital.curitiba.pr.gov.br option httpchk HEAD / HTTP/1.1\\r\\nHost: pmcdigital.curitiba.pr.gov.br http-check expect status 200 \\ server server01 vmprdapp-esc01.curitiba.pr.gov.br:8080 weight 1 maxconn 200 \\ server server02 vmprdapp-esc02.curitiba.pr.gov.br:8080 weight 1 maxconn 200 backend servicodigital.curitiba.pr.gov.br option httpchk HEAD / HTTP/1.1\\r\\nHost: servicodigital.curitiba.pr.gov.br \\ http-check expect status 200 \\ server server01 vmprdapp-esc01.curitiba.pr.gov.br:80 weight 1 maxconn 200 \\ server server02 vmprdapp-esc02.curitiba.pr.gov.br:80 weight 1 maxconn 200 backend servicodigitalservidor.curitiba.pr.gov.br option httpchk HEAD / HTTP/1.1\\r\\nHost: servicodigitalservidor.curitiba.pr.gov.br \\ http-check expect status 200 \\ server server01 vmprdapp-esc01.curitiba.pr.gov.br:80 weight 1 maxconn 200 \\ server server02 vmprdapp-esc02.curitiba.pr.gov.br:80 weight 1 maxconn 200 </code> {=html}","title":"Load Balance {#load_balance}"},{"location":"teste/#gestao-de-mudanca-gestao_de_mudanca","text":"","title":"Gest\u00e3o de mudan\u00e7a {#gest\u00e3o_de_mudan\u00e7a}"},{"location":"teste/#resumo","text":"Ser\u00e1 necess\u00e1rio alterar apontamento do proxy reverso. A infraestrutura standalone esta hospedada na solu\u00e7\u00e3o nginx (**vmprdprx-web**) <code bash> {=html} Sydle Java pmcdigital.curitiba.pr.gov.br [172.31.10.40] => ep.curitiba.pr.gov.br:8443 [172.31.31.180] Sydle PHP servicodigital.curitiba.pr.gov.br [172.31.10.40] => servicodigitalinterno.curitiba.pr.gov.br [172.31.31.180] servicodigitalservidor.curitiba.pr.gov.br [172.31.10.40] => int-servicodigitalservidor.curitiba.pr.gov.br [172.31.31.180] </code> {=html} A nova infraestrutura ser\u00e1 hospedada no Haproxy (**LBHASOLUTION**) <code bash> {=html} Sydle Java pmcdigital.curitiba.pr.gov.br [172.31.10.17] => vmprdapp-esc01.curitiba.pr.gov.br:8080 [172.31.24.4] pmcdigital.curitiba.pr.gov.br [172.31.10.17] => vmprdapp-esc02.curitiba.pr.gov.br:8080 [172.31.24.5] Sydle PHP servicodigital.curitiba.pr.gov.br [172.31.10.17] => vmprdapp-esc01.curitiba.pr.gov.br:80 [172.31.24.4] servicodigitalservidor.curitiba.pr.gov.br [172.31.10.17] => vmprdapp-esc01.curitiba.pr.gov.br:80 [172.31.24.5] </code> {=html}","title":"Resumo"},{"location":"teste/#procedimento-operacional-procedimento_operacional","text":"Procedimentos a serem executados na **infraestrutura standalone** 2 - Desabilitar Organiza\u00e7\u00e3o \\\\ 3 - Parar Tomcat VMPRDAPP-ESCPROC, VMPRDAPP-ESC01, VMPRDAPP-ESC02 \\\\ 4 - Parar MongoDB \\\\ 5 - Parar Elastic \u21d2 [root\\@VMPRDAPP-INDEX \\~]# systemctl stop elasticsearch \\\\ 6 - Replica\u00e7\u00e3o dos arquivos /sydleone <code bash> {=html} [root\\@VMPRDAPP-ESCPROC \\~]# rsync /sydleone/ -arvz -e \\'ssh -p 6293\\' --progress --delete root\\@vmprdapp-escfiles.curitiba.pr.gov.br:/sydleone/ [root\\@VMPRDAPP-ESCFILES \\~]# chown -R nfsnobody:nfsnobody /sydleone/ ; chmod -R 775 /sydleone/ </code> {=html} 7 - Replica\u00e7\u00e3o Elastic 7.1 - Apagar todos os \u00edndices da estrutura nova [ **VMPRDAPP-ESCELA01, VMPRDAPP-ESCELA02, VMPRDAPP-ESCELA03** ] <code bash> {=html} systemctl stop elasticsearch rm -rf /var/lib/elasticsearch/* </code> {=html} 7.2 - Replica\u00e7\u00e3o dados **VMPRDAPP-INDEX \u21d2 VMPRDAPP-ESCELA01** <code bash> {=html} Replica [root\\@VMPRDAPP-INDEX \\~]# rsync /var/lib/elasticsearch/ -arvz -e \\'ssh -p 6293\\' --progress --delete root\\@vmprdapp-escela01.curitiba.pr.gov.br:/var/lib/elasticsearch/ Corre\u00e7\u00e3o Permiss\u00f5es [root\\@VMPRDAPP-ESCELA01 \\~]# chown -R elasticsearch.elasticsearch /var/lib/elasticsearch [root\\@VMPRDAPP-ESCELA01 \\~]# rm -f /var/lib/elasticsearch/nodes/0/node.lock [root\\@VMPRDAPP-ESCELA01 \\~]# rm -f /var/lib/elasticsearch/nodes/0/_state </code> {=html} 7.3 - Iniciar Elastic / Valida\u00e7\u00e3o <code bash> {=html} [root\\@VMPRDAPP-ESCELA01 \\~]# systemctl start elasticsearch [root\\@VMPRDAPP-ESCELA02 \\~]# systemctl start elasticsearch [root\\@VMPRDAPP-ESCELA03 \\~]# systemctl start elasticsearch [root\\@VMPRDAPP-ESCELA01 \\~]# curl \\\" http://172.31.24.8:9200/_cat/health \\\" </code> {=html} 7.4 - Cria\u00e7\u00e3o de replicas <code bash> {=html} [root\\@VMPRDAPP-ESCELA01 \\~]# curl -H \\'Content-Type: application/json\\' -XPUT \\\" http://$HOSTNAME:9200/*5d122d72727e59522b60c339 .*/_settings\\\" -d \\'{\\\"index\\\" : {\\\"number_of_replicas\\\" : 1}}\\' [root\\@VMPRDAPP-ESCELA01 \\~]# curl -H \\'Content-Type: application/json\\' -XPUT \\\" http://$HOSTNAME:9200/*000000000000111111111111 .*/_settings\\\" -d \\'{\\\"index\\\" : {\\\"number_of_replicas\\\" : 1}}\\' Valida\u00e7\u00e3o [root\\@VMPRDAPP-ESCELA01 \\~]# curl \\\" http://172.31.24.8:9200/_cat/allocation \\\" [root\\@VMPRDAPP-ESCELA01 \\~]# curl \\\" http://172.31.24.8:9200/_cat/indices/ *?h=index,pri,rep,docs.count,docs.deleted,pri.store.size&s=pri.store.size:desc&v\\\" [root\\@VMPRDAPP-ESCELA01 \\~]# curl \\\" http://172.31.24.8:9200/_cat/health \\\" </code> {=html} 8 - Migra\u00e7\u00e3o banco de dados MongoDB 8.1 - Parar servi\u00e7o do mongodb nos servidores **VMPRDAPP-ECM (172.31.31.181), VMPRDAPP-ESCPROCRPL (172.31.31.183), VMPRDAPP-ESCPROC (172.31.31.180)** su - mongodb mongo --port 27017 --username \"admin\" --password \"########\" --authenticationDatabase \"admin\" use admin db.shutdownServer() 8.2 Copiar os bin\u00e1rios e remover dados desatualizados nos servidores **VMPRDDB-ESCMONGO01, VMPRDDB-ESCMONGO02, VMPRDDB-ESCMONGO03** cp -Ra /data/mongodb/mongodb-linux-x86_64-rhel70-4.2.17/ /data/ (temporariamente) rm -rf /data/mongodb/* 8.3 - Replicar dados <code bash> {=html} Iniciar a c\u00f3pia dentro do servidor VMPRDAPP-ESCPROCRPL (172.31.31.183) time rsync -av --delete -e \\'ssh -p 6293\\' /mongodb/data/* root\\@10.0.0.19:/data/mongodb Devolver o diret\u00f3rio /data/mongodb/mongodb-linux-x86_64-rhel70-4.2.17/ para o /data/mongodb (servidores ESCMONGO) mv /data/mongodb-linux-x86_64-rhel70-4.2.17/ /data/mongodb/ Iniciar o servi\u00e7o no n\u00f3 Prim\u00e1rio (VMPRDDB-ESCMONGO01) su - mongodb mongod --fork --config /etc/mongod.conf Conectar no MongoDB mongo --port 27017 --username \\\"admin\\\" --password \\\"########\\\" --authenticationDatabase \\\"admin\\\" Refazer a configura\u00e7\u00e3o do replicaset cfg = {_id: \\'sdlPrdSet\\', members: [ {_id: 0, host: 'vmprddb-escmongo01:27017'}, \\ {_id: 1, host: 'vmprddb-escmongo02:27017'}, \\ {_id: 2, host: 'vmprddb-escmongo03:27017', arbiterOnly: true}] } rs.reconfig(cfg, {force: true}); Acessar os servidores VMPRDDB-ESCMONGO02 e VMPRDDB-ESCMONGO03 e iniciar os servi\u00e7os mv /data/mongodb-linux-x86_64-rhel70-4.2.17/ /data/mongodb/ su - mongodb mongod --fork --config /etc/mongod.conf Alterar a prioridade do secondary para fazer failback autom\u00e1tico caso o n\u00f3 1 caia e volte depois cfg = rs.conf(); cfg.members[1].priority = 0.5; rs.reconfig(cfg); Obs.: Durante a c\u00f3pia para o servidor secund\u00e1rio, o status ficar\u00e1 sdlPrdSet:STARTUP2 <!-- --> Ap\u00f3s a c\u00f3pia dos dados, fazer as altera\u00e7\u00f5es nas bases escmongo (usando o n\u00f3 prim\u00e1rio) use 000000000000111111111111 db.getCollection(\\'000000002337c25acecc394e\\').update({\\\"_id\\\" : ObjectId(\\\"000000000000000331111111\\\")},{\\\"\\$set\\\": {\\\"5da721852337c25acecc3922\\\": \\\" mongodb://sydleone:sydleonep101\\@VMPRDDB-ESCMONGO01:27017,VMPRDDB-ESCMONGO02:27017/?connectTimeoutMS=300000 \\\"}}) db.getCollection(\\'000000002337c25acecc38cc\\').update({\\\"_id\\\" : ObjectId(\\\"000000000000000221111111\\\")},{\\\"\\$set\\\": {\\\"5da71e5b2337c25acecc38c0\\\": \\\"cluster-sydleone\\\"}}) db.getCollection(\\'000000002337c25acecc38cc\\').update({\\\"_id\\\" : ObjectId(\\\"000000000000000221111111\\\")},{\\\"\\$set\\\": {\\\"5da71e912337c25acecc38c4\\\": [ \\\" http://VMPRDAPP-ESCELA01:9200 \\\", \\\" http://VMPRDAPP-ESCELA02:9200 \\\", \\\" http://VMPRDAPP-ESCELA03:9200 \\\" ]}}) Desabilitar organiza\u00e7\u00e3o db.getCollection(\\'000000000000000000000333\\').updateOne({ _id: ObjectId('5d122d72727e59522b60c339') },{ $set: { \\ \"5d9f5cf5f5730067840dc3c3\" : false \\ } }) </code> {=html} 9 - Iniciar a aplica\u00e7\u00e3o Java em ** VMPRDAPP-ESC01, VMPRDAPP-ESC02, VMPRDAPP-ESC03, VMPRDAPP-ESC04 ** <code bash> {=html} systemctl start tomcat8 </code> {=html} 10 - Altera\u00e7\u00e3o de registros DNS * pmcdigital.curitiba.pr.gov.br \u21d2 172.31.10.17 \\ * pmcdigital.curitiba.pr.gov.br \u21d2 177.125.179.67 \\ * servicodigital.curitiba.pr.gov.br \u21d2 172.31.10.17 \\ * servicodigital.curitiba.pr.gov.br \u21d2 177.125.179.67 \\ * servicodigitalservidor.curitiba.pr.gov.br \u21d2 172.31.10.17 \\ * servicodigitalservidor.curitiba.pr.gov.br \u21d2 177.125.179.67","title":"Procedimento Operacional {#procedimento_operacional}"},{"location":"teste/#troubleshooting","text":"http://server:8080/system/sys/admin \\\\","title":"Troubleshooting"}]}